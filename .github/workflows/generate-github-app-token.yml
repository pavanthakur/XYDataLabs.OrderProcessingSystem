name: Azure Bootstrap Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for Azure OIDC (dev/staging/prod)' 
        required: true
        type: choice
        options: [dev, staging, prod]
      setupOidc:
        description: 'Run Azure OIDC setup (must be true for GitHub App step)'
        required: true
        type: boolean
        default: true
      generateAppToken:
        description: 'Generate GitHub App installation access token'
        required: true
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  setup-oidc:
    name: Step 1 - Setup Azure OIDC
    if: inputs.setupOidc
    runs-on: windows-latest
    outputs:
      clientId: ${{ steps.capture.outputs.clientId }}
      tenantId: ${{ steps.capture.outputs.tenantId }}
      subscriptionId: ${{ steps.capture.outputs.subscriptionId }}
    steps:
      - name: Start OIDC Step
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "ğŸš€ STARTING AZURE OIDC SETUP" -ForegroundColor Cyan
          Write-Host "Environment: ${{ inputs.environment }}" -ForegroundColor Gray
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan

      - name: Azure Login (Device Code)
        timeout-minutes: 3
        run: |
          try {
            Write-Host "ğŸ” Initiating Azure login with device code..." -ForegroundColor Cyan
            az login --use-device-code
            if ($LASTEXITCODE -ne 0) {
              throw "Azure login failed with exit code: $LASTEXITCODE"
            }
            Write-Host "âœ… Azure login successful" -ForegroundColor Green
          }
          catch {
            Write-Host "âŒ ERROR: Azure login failed" -ForegroundColor Red
            Write-Host "Error details: $_" -ForegroundColor Red
            Write-Error "Azure login failed. Please check your credentials and try again."
            exit 1
          }

      - name: Capture Azure OIDC Values
        id: capture
        run: |
          try {
            Write-Host "ğŸ“‹ Retrieving Azure subscription details..." -ForegroundColor Cyan
            $sub = az account show | ConvertFrom-Json
            if (-not $sub) { 
              throw "Failed to read Azure subscription context"
            }
            $tenantId = $sub.tenantId
            $subscriptionId = $sub.id
            Write-Host "âœ… Subscription details retrieved" -ForegroundColor Green
            
            Write-Host "ğŸ” Looking for OIDC App Registration 'GitHub-Actions-OIDC'..." -ForegroundColor Cyan
            $app = az ad app list --display-name "GitHub-Actions-OIDC" | ConvertFrom-Json
            if (-not $app -or $app.Count -eq 0) {
              Write-Host "âŒ ERROR: OIDC App Registration not found" -ForegroundColor Red
              throw "OIDC App Registration 'GitHub-Actions-OIDC' not found. Run initial bootstrap workflow first."
            }
            $clientId = $app[0].appId
            Write-Host "âœ… OIDC App Registration found" -ForegroundColor Green
            
            "clientId=$clientId" >> $env:GITHUB_OUTPUT
            "tenantId=$tenantId" >> $env:GITHUB_OUTPUT
            "subscriptionId=$subscriptionId" >> $env:GITHUB_OUTPUT
            
            Write-Host "`nâœ… Successfully captured OIDC values:" -ForegroundColor Green
            Write-Host "  ClientId: $clientId" -ForegroundColor Gray
            Write-Host "  TenantId: $tenantId" -ForegroundColor Gray
            Write-Host "  SubscriptionId: $subscriptionId" -ForegroundColor Gray
          }
          catch {
            Write-Host "âŒ ERROR: Failed to capture Azure OIDC values" -ForegroundColor Red
            Write-Host "Error details: $_" -ForegroundColor Red
            Write-Error "OIDC setup failed. $_"
            exit 1
          }

      - name: Complete OIDC Step
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "âœ… AZURE OIDC SETUP COMPLETED" -ForegroundColor Green
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan

  github-app-token:
    name: Step 2 - Generate GitHub App Token
    if: inputs.generateAppToken && (needs.setup-oidc.result == 'success' || needs.setup-oidc.result == 'skipped')
    needs: [setup-oidc]
    runs-on: windows-latest
    env:
      GH_APP_ID: ${{ secrets.GH_APP_ID }}
      GH_APP_INSTALLATION_ID: ${{ secrets.GH_APP_INSTALLATION_ID }}
      GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}
    steps:
      - name: Pre-Check OIDC Completion
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "ğŸ”’ VALIDATING OIDC COMPLETION BEFORE GITHUB APP TOKEN" -ForegroundColor Cyan
          if ('${{ needs.setup-oidc.outputs.clientId }}' -eq '') { Write-Error "OIDC setup outputs missing (clientId). Aborting GitHub App token generation."; exit 1 }
          Write-Host "âœ… OIDC step outputs present. Proceeding." -ForegroundColor Green
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray

      - name: Check GitHub App Secrets
        id: check
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "ğŸ” CHECKING GITHUB APP CONFIGURATION STATUS" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          $appId = $env:GH_APP_ID
          $instId = $env:GH_APP_INSTALLATION_ID
          $pkey = $env:GH_APP_PRIVATE_KEY
          $missing = @()
          function Flag([string]$label,[string]$val) {
            if (-not $val) { Write-Host "  $label : âŒ Missing"; $missing += $label } else { Write-Host "  $label : âœ… Present" }
          }
          Write-Host "\nğŸ“‹ Required Secrets:" -ForegroundColor Gray
          Flag 'GH_APP_ID' $appId
          Flag 'GH_APP_INSTALLATION_ID' $instId
          Flag 'GH_APP_PRIVATE_KEY' $pkey
          if ($missing.Count -gt 0) {
            Write-Host "\nâŒ GitHub App Configuration Status: INCOMPLETE" -ForegroundColor Red
            Write-Host "\n  One or more required secrets are missing." -ForegroundColor Yellow
            Write-Host "  Manual setup is required to enable automation." -ForegroundColor Yellow
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
            Write-Error "Missing secrets: $($missing -join ', ')"; exit 1
          } else {
            Write-Host "\nâœ… GitHub App Configuration Status: COMPLETE" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          }
          "ready=true" >> $env:GITHUB_OUTPUT

      - name: Generate Installation Token
        if: steps.check.outputs.ready == 'true'
        id: generate
        run: |
          try {
            Write-Host "ğŸ” Generating GitHub App installation access token..." -ForegroundColor Cyan
            
            # Private key needs normalization (handle literal \n sequences if supplied that way)
            $rawKey = $env:GH_APP_PRIVATE_KEY
            if ($rawKey -match '\\n') { $rawKey = ($rawKey -replace '\\n',"`n") }
            $pemPath = "$env:RUNNER_TEMP\app_private_key.pem"
            Set-Content -Path $pemPath -Value $rawKey -NoNewline
            Write-Host "âœ… Private key loaded" -ForegroundColor Green
            
            # Build JWT
            Write-Host "ğŸ”§ Building JWT..." -ForegroundColor Cyan
            $appId = $env:GH_APP_ID
            $now = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds()
            $payload = @{ iat = $now; exp = $now + 540; iss = $appId }
            $header = @{ alg = 'RS256'; typ='JWT' }
            
            function ToBase64Url($obj) {
              $json = ($obj | ConvertTo-Json -Compress)
              $bytes = [System.Text.Encoding]::UTF8.GetBytes($json)
              $b64 = [Convert]::ToBase64String($bytes).TrimEnd('=') -replace '\+','-' -replace '/','_'
              return $b64
            }
            
            $segments = @()
            $segments += ToBase64Url $header
            $segments += ToBase64Url $payload
            $unsigned = ($segments -join '.')
            
            $rsa = [System.Security.Cryptography.RSA]::Create()
            $pem = Get-Content $pemPath -Raw
            $pem = $pem -replace '-----BEGIN PRIVATE KEY-----','' -replace '-----END PRIVATE KEY-----','' -replace '\s',''
            $pkBytes = [Convert]::FromBase64String($pem)
            $rsa.ImportPkcs8PrivateKey($pkBytes,[ref]0) | Out-Null
            
            $sig = $rsa.SignData([System.Text.Encoding]::UTF8.GetBytes($unsigned),[System.Security.Cryptography.HashAlgorithmName]::SHA256,[System.Security.Cryptography.RSASignaturePadding]::Pkcs1)
            $sigB64 = [Convert]::ToBase64String($sig).TrimEnd('=') -replace '\+','-' -replace '/','_'
            $jwt = "$unsigned.$sigB64"
            Write-Host "âœ… JWT generated (length: $($jwt.Length) chars)" -ForegroundColor Green
            
            # Request installation token
            Write-Host "ğŸ“¡ Requesting installation token from GitHub API..." -ForegroundColor Cyan
            $instId = $env:GH_APP_INSTALLATION_ID
            $resp = Invoke-RestMethod -Method Post -Uri "https://api.github.com/app/installations/$instId/access_tokens" -Headers @{ Authorization = "Bearer $jwt"; Accept = 'application/vnd.github+json' } -Body '{}' -ErrorAction Stop
            
            $token = $resp.token
            if (-not $token) { 
              throw "Failed to obtain installation token from GitHub API response"
            }
            
            Write-Host "âœ… Installation token acquired successfully" -ForegroundColor Green
            Write-Host "  Expires: $($resp.expires_at)" -ForegroundColor Gray
            "installationToken=$token" >> $env:GITHUB_OUTPUT
          }
          catch {
            Write-Host "âŒ ERROR: Failed to generate GitHub App installation token" -ForegroundColor Red
            Write-Host "Error details: $_" -ForegroundColor Red
            
            if ($_.Exception.Message -match "401") {
              Write-Host "Hint: Check that GH_APP_ID and GH_APP_PRIVATE_KEY are correct" -ForegroundColor Yellow
            }
            elseif ($_.Exception.Message -match "404") {
              Write-Host "Hint: Check that GH_APP_INSTALLATION_ID is correct" -ForegroundColor Yellow
            }
            
            Write-Error "GitHub App token generation failed. $_"
            exit 1
          }

      - name: Summary
        if: steps.generate.outputs.installationToken != ''
        run: |
          "## ğŸ” GitHub App Token Generated" >> $env:GITHUB_STEP_SUMMARY
          "Expires: ${{ steps.generate.outputs.expires }}" >> $env:GITHUB_STEP_SUMMARY
          "(Token not printed for security)" >> $env:GITHUB_STEP_SUMMARY

  summary:
    name: Run Summary
    if: always()
    needs: [setup-oidc, github-app-token]
    runs-on: windows-latest
    steps:
      - name: Final Status
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "ğŸ“Š WORKFLOW EXECUTION SUMMARY" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          
          $oidcResult = "${{ needs.setup-oidc.result }}"
          $githubAppResult = "${{ needs.github-app-token.result }}"
          
          Write-Host "`nJob Results:" -ForegroundColor White
          
          # OIDC Setup Status
          Write-Host "  1. Setup Azure OIDC: " -NoNewline
          switch ($oidcResult) {
            "success" { Write-Host "âœ… SUCCESS" -ForegroundColor Green }
            "failure" { Write-Host "âŒ FAILED" -ForegroundColor Red }
            "cancelled" { Write-Host "âš ï¸ CANCELLED" -ForegroundColor Yellow }
            "skipped" { Write-Host "â­ï¸ SKIPPED" -ForegroundColor Gray }
            default { Write-Host "â“ $oidcResult" -ForegroundColor Gray }
          }
          
          # GitHub App Token Status
          Write-Host "  2. Generate GitHub App Token: " -NoNewline
          switch ($githubAppResult) {
            "success" { Write-Host "âœ… SUCCESS" -ForegroundColor Green }
            "failure" { Write-Host "âŒ FAILED" -ForegroundColor Red }
            "cancelled" { Write-Host "âš ï¸ CANCELLED" -ForegroundColor Yellow }
            "skipped" { Write-Host "â­ï¸ SKIPPED" -ForegroundColor Gray }
            default { Write-Host "â“ $githubAppResult" -ForegroundColor Gray }
          }
          
          Write-Host "`nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          
          # Overall workflow status
          $hasFailure = ($oidcResult -eq "failure") -or ($githubAppResult -eq "failure")
          
          if ($hasFailure) {
            Write-Host "âš ï¸ WORKFLOW COMPLETED WITH FAILURES" -ForegroundColor Red
            Write-Host "`nFailure Analysis:" -ForegroundColor Yellow
            
            if ($oidcResult -eq "failure") {
              Write-Host "  â€¢ OIDC Setup Failed:" -ForegroundColor Red
              Write-Host "    - Check Azure login credentials" -ForegroundColor Gray
              Write-Host "    - Verify OIDC app registration exists" -ForegroundColor Gray
              Write-Host "    - Review job logs for detailed error messages" -ForegroundColor Gray
            }
            
            if ($githubAppResult -eq "failure") {
              Write-Host "  â€¢ GitHub App Token Generation Failed:" -ForegroundColor Red
              Write-Host "    - Verify GitHub App secrets are configured" -ForegroundColor Gray
              Write-Host "    - Check GH_APP_ID, GH_APP_INSTALLATION_ID, GH_APP_PRIVATE_KEY" -ForegroundColor Gray
              Write-Host "    - Review job logs for detailed error messages" -ForegroundColor Gray
            }
            
            Write-Host "`nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
            Write-Error "Workflow failed. See failure analysis above."
            exit 1
          }
          else {
            Write-Host "âœ… WORKFLOW COMPLETED SUCCESSFULLY" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          }
