name: Azure Bootstrap Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to bootstrap'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
          - all
      setupOidc:
        description: 'Setup Azure OIDC (first-time only)'
        required: true
        type: boolean
        default: false
      setupGitHubApp:
        description: 'Setup GitHub App (required for automated secret management - first-time only)'
        required: true
        type: boolean
        default: false
      oidcAppName:
        description: 'OIDC App Name (requires GitHub App setup)'
        required: false
        type: string
        default: 'GitHub-Actions-OIDC'
      configureSecrets:
        description: 'Configure GitHub secrets (auto if GitHub App configured)'
        required: true
        type: boolean
        default: false
      enableValidation:
        description: 'Enable pre-deployment validation'
        required: true
        type: boolean
        default: true
      bootstrapInfra:
        description: 'Bootstrap infrastructure (App Services, etc.)'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  check-trigger:
    name: Check Workflow Trigger
    if: github.event_name != 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - name: Workflow trigger check
        run: |
          Write-Host "â„¹ï¸  This workflow is designed for manual dispatch only" -ForegroundColor Cyan
          Write-Host "   Skipping execution for event: ${{ github.event_name }}" -ForegroundColor Yellow
          Write-Host "   To run this workflow, use: Actions > Azure Bootstrap Setup > Run workflow" -ForegroundColor Gray

  validate-inputs:
    name: Validate Workflow Inputs
    if: github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - name: Log Workflow Start
        run: |
          Write-Host "" -ForegroundColor Gray
          Write-Host "========================================================================" -ForegroundColor Cyan
          Write-Host "  AZURE BOOTSTRAP WORKFLOW STARTED" -ForegroundColor Cyan
          Write-Host "========================================================================" -ForegroundColor Cyan
          Write-Host "" -ForegroundColor Gray
          Write-Host "â° Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "ğŸ‘¤ Triggered by: ${{ github.actor }}" -ForegroundColor Gray
          Write-Host "ğŸŒ¿ Branch: ${{ github.ref_name }}" -ForegroundColor Gray
          Write-Host "ğŸ“¦ Repository: ${{ github.repository }}" -ForegroundColor Gray
          Write-Host "ğŸ”— Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray
          Write-Host "ğŸ“‹ USER SELECTED PARAMETERS:" -ForegroundColor Yellow
          Write-Host "  âœ“ Target environment:           ${{ inputs.environment }}" -ForegroundColor White
          Write-Host "  âœ“ Setup Azure OIDC:             ${{ inputs.setupOidc }}" -ForegroundColor White
          Write-Host "  âœ“ Setup GitHub App:             ${{ inputs.setupGitHubApp }}" -ForegroundColor White
          Write-Host "  âœ“ OIDC App Name:                ${{ inputs.oidcAppName }}" -ForegroundColor White
          Write-Host "  âœ“ Enable validation:            ${{ inputs.enableValidation }}" -ForegroundColor White
          Write-Host "  âœ“ Bootstrap infrastructure:     ${{ inputs.bootstrapInfra }}" -ForegroundColor White
          Write-Host "  âœ“ Configure GitHub secrets:     ${{ inputs.configureSecrets }}" -ForegroundColor White
          Write-Host "" -ForegroundColor Gray
          Write-Host "========================================================================" -ForegroundColor Cyan
          Write-Host "" -ForegroundColor Gray

      - name: Validate Configuration
        run: |
          Write-Host "ğŸ” Validating workflow inputs..." -ForegroundColor Cyan
          Write-Host "=" * 70 -ForegroundColor Gray

          $env = "${{ inputs.environment }}"
          $setupOidc = "${{ inputs.setupOidc }}"
          $setupGitHubApp = "${{ inputs.setupGitHubApp }}"
          $enableValidation = "${{ inputs.enableValidation }}"
          $bootstrap = "${{ inputs.bootstrapInfra }}"
          $configSecrets = "${{ inputs.configureSecrets }}"

          Write-Host "`nğŸ“‹ Workflow Inputs:" -ForegroundColor Cyan
          Write-Host "  Environment: $env" -ForegroundColor Yellow
          Write-Host "  Setup OIDC: $setupOidc" -ForegroundColor Yellow
          Write-Host "  Setup GitHub App: $setupGitHubApp" -ForegroundColor Yellow
          Write-Host "  Enable validation: $enableValidation" -ForegroundColor Yellow
          Write-Host "  Bootstrap infra: $bootstrap" -ForegroundColor Yellow
          Write-Host "  Configure secrets: $configSecrets" -ForegroundColor Yellow

          # Display branch-to-environment mapping
          Write-Host "`nğŸ—ºï¸  Branch â†’ Environment Mapping:" -ForegroundColor Cyan
          Write-Host "  dev branch      â†’ dev environment (dev.json)" -ForegroundColor Gray
          Write-Host "  staging branch  â†’ staging environment (staging.json)" -ForegroundColor Gray
          Write-Host "  main branch     â†’ prod environment (prod.json)" -ForegroundColor Gray

          # Show what will be created based on selection
          Write-Host "`nğŸ“¦ Resources to be created:" -ForegroundColor Cyan
          if ($env -eq "all") {
            Write-Host "  OIDC Credentials:" -ForegroundColor Yellow
            Write-Host "    - dev branch (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/dev)" -ForegroundColor Gray
            Write-Host "    - staging branch (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/staging)" -ForegroundColor Gray
            Write-Host "    - main branch (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/main)" -ForegroundColor Gray
            Write-Host "    - dev environment (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:dev)" -ForegroundColor Gray
            Write-Host "    - staging environment (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:staging)" -ForegroundColor Gray
            Write-Host "    - prod environment (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:prod)" -ForegroundColor Gray
            Write-Host "  GitHub Secrets: dev, staging, prod" -ForegroundColor Yellow
            Write-Host "  Bootstrap: dev, staging, prod resource groups" -ForegroundColor Yellow
          } else {
            Write-Host "  OIDC Credentials:" -ForegroundColor Yellow
            Write-Host "    - $env branch (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/$env)" -ForegroundColor Gray
            Write-Host "    - $env environment (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:$env)" -ForegroundColor Gray
            Write-Host "  GitHub Secrets: $env" -ForegroundColor Yellow
            Write-Host "  Bootstrap: $env resource group" -ForegroundColor Yellow
          }

          Write-Host "`nâš ï¸  Validation Checks:" -ForegroundColor Cyan

          # Validate environment selection
          if ($env -notin @('dev', 'staging', 'prod', 'all')) {
            Write-Host "  âŒ Invalid environment: $env" -ForegroundColor Red
            Write-Error "Invalid environment: $env. Must be dev, staging, prod, or all."
            exit 1
          }
          Write-Host "  âœ… Environment selection valid" -ForegroundColor Green

          # Warn if bootstrapping without OIDC/secrets
          if ($bootstrap -eq "true" -and $setupOidc -eq "false" -and $configSecrets -eq "false") {
            Write-Host "  âš ï¸  Bootstrapping without OIDC/secrets - ensure they exist!" -ForegroundColor Yellow
          } else {
            Write-Host "  âœ… Configuration sequence valid" -ForegroundColor Green
          }

          Write-Host "`n" -ForegroundColor Gray
          Write-Host "=" * 70 -ForegroundColor Gray
          Write-Host "âœ… Input validation passed - proceeding..." -ForegroundColor Green

  setup-oidc:
    name: Setup Azure OIDC
    if: inputs.setupOidc
    needs: [validate-inputs]
    runs-on: windows-latest
    outputs:
      clientId: ${{ steps.oidc.outputs.clientId }}
      tenantId: ${{ steps.oidc.outputs.tenantId }}
      subscriptionId: ${{ steps.oidc.outputs.subscriptionId }}
      appObjectId: ${{ steps.oidc.outputs.appObjectId }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (Device Code)
        timeout-minutes: 3
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         AZURE LOGIN - DEVICE CODE AUTHENTICATION              â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          Write-Host "ğŸ” Azure Login Required" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "This is a one-time setup. Please authenticate when prompted." -ForegroundColor White
          Write-Host "â±ï¸  Timeout: 3 minutes" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "Starting Azure CLI login..." -ForegroundColor Cyan
          Write-Host ""
          
          try {
            az login --use-device-code
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host ""
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ AZURE LOGIN FAILED" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Exit Code: $LASTEXITCODE" -ForegroundColor Red
              Write-Host ""
              Write-Host "Possible reasons:" -ForegroundColor Yellow
              Write-Host "  1. Authentication timeout (3 minutes)" -ForegroundColor Gray
              Write-Host "  2. Device code not entered" -ForegroundColor Gray
              Write-Host "  3. Azure CLI not configured properly" -ForegroundColor Gray
              Write-Host "  4. Network connectivity issues" -ForegroundColor Gray
              Write-Host ""
              Write-Host "To resolve:" -ForegroundColor Cyan
              Write-Host "  - Re-run this workflow" -ForegroundColor White
              Write-Host "  - Complete the device code authentication within 3 minutes" -ForegroundColor White
              Write-Host "  - Ensure you have proper Azure permissions" -ForegroundColor White
              Write-Host ""
              Write-Error "Azure login failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
            
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "âœ… AZURE LOGIN SUCCESSFUL" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING AZURE LOGIN" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Error "Azure login failed with exception: $($_.Exception.Message)"
            exit 1
          }

      - name: Setup OIDC App Registration
        id: oidc
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         SETUP GITHUB ACTIONS OIDC                             â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""

          try {
            # Determine branches and environments based on input
            $selectedEnv = "${{ inputs.environment }}"
            if ($selectedEnv -eq "all") {
              $branches = "dev,staging,main"
              $environments = "dev,staging,prod"
            } else {
              $branches = $selectedEnv
              $environments = $selectedEnv
            }

            Write-Host "ğŸ“‹ Configuration:" -ForegroundColor Yellow
            Write-Host "  Branches: $branches" -ForegroundColor Gray
            Write-Host "  Environments: $environments" -ForegroundColor Gray
            Write-Host "  Repository: pavanthakur/XYDataLabs.OrderProcessingSystem" -ForegroundColor Gray
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
            Write-Host "ğŸš€ Running OIDC setup script..." -ForegroundColor Cyan
            Write-Host ""

            # Run setup script
            ./Resources/Azure-Deployment/setup-github-oidc.ps1 `
              -Branches $branches `
              -Environments $environments `
              -GitHubOwner "pavanthakur" `
              -Repository "XYDataLabs.OrderProcessingSystem" `
              -AppDisplayName "${{ inputs.oidcAppName }}"

            if ($LASTEXITCODE -ne 0) {
              Write-Host ""
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ OIDC SETUP SCRIPT FAILED" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Exit Code: $LASTEXITCODE" -ForegroundColor Red
              Write-Host "Script: ./Resources/Azure-Deployment/setup-github-oidc.ps1" -ForegroundColor Gray
              Write-Host ""
              Write-Host "Parameters used:" -ForegroundColor Yellow
              Write-Host "  -Branches: $branches" -ForegroundColor Gray
              Write-Host "  -Environments: $environments" -ForegroundColor Gray
              Write-Host "  -GitHubOwner: pavanthakur" -ForegroundColor Gray
              Write-Host "  -Repository: XYDataLabs.OrderProcessingSystem" -ForegroundColor Gray
              Write-Host ""
              Write-Error "OIDC setup script failed with exit code $LASTEXITCODE. Check the script output above for details."
              exit $LASTEXITCODE
            }

            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "ğŸ” Extracting Azure credentials..." -ForegroundColor Cyan
            Write-Host ""

            # Extract credentials from Azure
            Write-Host "Fetching Azure subscription information..." -ForegroundColor Gray
            $sub = az account show | ConvertFrom-Json
            if (-not $sub) {
              Write-Host ""
              Write-Host "âŒ Failed to get Azure subscription" -ForegroundColor Red
              Write-Host ""
              Write-Host "Possible reasons:" -ForegroundColor Yellow
              Write-Host "  1. Azure CLI session expired" -ForegroundColor Gray
              Write-Host "  2. No active subscription" -ForegroundColor Gray
              Write-Host "  3. Network connectivity issues" -ForegroundColor Gray
              Write-Host ""
              Write-Error "Failed to get Azure subscription information"
              exit 1
            }
            Write-Host "  âœ… Subscription retrieved" -ForegroundColor Green

            Write-Host "Fetching OIDC app registration..." -ForegroundColor Gray
            $oidcAppName = "${{ inputs.oidcAppName }}"
            $app = az ad app list --display-name $oidcAppName | ConvertFrom-Json
            if (-not $app -or $app.Count -eq 0) {
              Write-Host ""
              Write-Host "âŒ Failed to create or find OIDC app" -ForegroundColor Red
              Write-Host ""
              Write-Host "App Name: $oidcAppName" -ForegroundColor Gray
              Write-Host ""
              Write-Host "Possible reasons:" -ForegroundColor Yellow
              Write-Host "  1. App creation failed in setup script" -ForegroundColor Gray
              Write-Host "  2. Insufficient Azure AD permissions" -ForegroundColor Gray
              Write-Host "  3. App name conflict" -ForegroundColor Gray
              Write-Host ""
              Write-Error "Failed to create or find OIDC app '$oidcAppName'"
              exit 1
            }
            Write-Host "  âœ… OIDC app found" -ForegroundColor Green

            $clientId = $app[0].appId
            $appObjectId = $app[0].id
            $tenantId = $sub.tenantId
            $subscriptionId = $sub.id

            Write-Host ""
            Write-Host "ğŸ“ Validating extracted credentials..." -ForegroundColor Cyan
            if (-not $clientId) {
              Write-Error "Client ID is null or empty"
              exit 1
            }
            if (-not $appObjectId) {
              Write-Error "App Object ID is null or empty"
              exit 1
            }
            if (-not $tenantId) {
              Write-Error "Tenant ID is null or empty"
              exit 1
            }
            if (-not $subscriptionId) {
              Write-Error "Subscription ID is null or empty"
              exit 1
            }
            Write-Host "  âœ… All credentials validated" -ForegroundColor Green

            # Output for next jobs
            Write-Host ""
            Write-Host "ğŸ“¤ Setting job outputs..." -ForegroundColor Cyan
            "clientId=$clientId" >> $env:GITHUB_OUTPUT
            "tenantId=$tenantId" >> $env:GITHUB_OUTPUT
            "subscriptionId=$subscriptionId" >> $env:GITHUB_OUTPUT
            "appObjectId=$appObjectId" >> $env:GITHUB_OUTPUT

            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "âœ… OIDC SETUP COMPLETE" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "Credentials Summary:" -ForegroundColor Yellow
            Write-Host "  Client ID: $clientId" -ForegroundColor Gray
            Write-Host "  Tenant ID: $tenantId" -ForegroundColor Gray
            Write-Host "  Subscription ID: $subscriptionId" -ForegroundColor Gray
            Write-Host "  App Object ID: $appObjectId" -ForegroundColor Gray
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING OIDC SETUP" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
            Write-Error "OIDC setup failed with exception: $($_.Exception.Message)"
            exit 1
          }

      - name: Verify Federated Credentials
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         VERIFY FEDERATED CREDENTIALS                          â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""

          try {
            $appObjectId = "${{ steps.oidc.outputs.appObjectId }}"
            $expectedPattern = "repo:pavanthakur/XYDataLabs.OrderProcessingSystem"
            $selectedEnv = "${{ inputs.environment }}"
            $expectedCount = if ($selectedEnv -eq "all") { 6 } else { 2 }
            $maxRetries = 3
            $retryDelay = 20
            $validCreds = $null

            Write-Host "ğŸ“‹ Verification Configuration:" -ForegroundColor Yellow
            Write-Host "  App Object ID: $appObjectId" -ForegroundColor Gray
            Write-Host "  Expected Pattern: $expectedPattern" -ForegroundColor Gray
            Write-Host "  Target Environment: $selectedEnv" -ForegroundColor Gray
            Write-Host "  Expected Credential Count: $expectedCount" -ForegroundColor Gray
            Write-Host "  Max Retries: $maxRetries" -ForegroundColor Gray
            Write-Host "  Retry Delay: $retryDelay seconds" -ForegroundColor Gray
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
            Write-Host "ğŸ” Verifying federated credentials..." -ForegroundColor Cyan
            Write-Host ""

            for ($i = 1; $i -le $maxRetries; $i++) {
              Write-Host "`n[Attempt $i/$maxRetries] Waiting $retryDelay seconds for Azure AD propagation..." -ForegroundColor Gray
              Start-Sleep -Seconds $retryDelay

              Write-Host "Purging Azure CLI cache and querying credentials..." -ForegroundColor Gray
              az cache purge 2>$null | Out-Null
              $creds = az ad app federated-credential list --id $appObjectId | ConvertFrom-Json

              $validCount = ($creds | Where-Object { $_.subject -like "$expectedPattern*" }).Count
              Write-Host "Found $validCount/$($creds.Count) credentials with correct format" -ForegroundColor $(if ($validCount -eq $expectedCount) { "Green" } else { "Yellow" })

              if ($validCount -eq $expectedCount) {
                Write-Host "âœ… All credentials have propagated correctly!" -ForegroundColor Green
                $validCreds = $creds
                break
              }

              if ($i -lt $maxRetries) {
                Write-Host "âš ï¸ Still seeing old credentials, retrying..." -ForegroundColor Yellow
              }
              }

            if (-not $validCreds) {
              Write-Warning "Azure AD still showing stale credentials after $($maxRetries * $retryDelay) seconds"
              Write-Warning "This is likely an Azure AD caching issue. Proceeding with manual verification..."
              $creds = az ad app federated-credential list --id $appObjectId | ConvertFrom-Json
            } else {
              $creds = $validCreds
            }

            Write-Host "`nCreated federated credentials:" -ForegroundColor Green
            foreach ($cred in $creds) {
              Write-Host "  - Name: $($cred.name)" -ForegroundColor White
              Write-Host "    Subject: $($cred.subject)" -ForegroundColor Gray
            }

            if ($creds.Count -lt $expectedCount) {
              Write-Warning "Expected $expectedCount federated credentials, found $($creds.Count). OIDC setup may be incomplete."
              Write-Warning "Re-run this workflow with 'Setup OIDC' enabled to create missing credentials."
            } else {
              Write-Host "`nâœ… All $expectedCount federated credentials verified!" -ForegroundColor Green
            }

            Write-Host "`nğŸ” Checking for required credentials..." -ForegroundColor Cyan

            # Check branch credential for selected environment
            Write-Host "Searching for $selectedEnv branch credential..." -ForegroundColor Gray
            $expectedBranch = "repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/$selectedEnv"
            Write-Host "Expected: $expectedBranch" -ForegroundColor Gray
            $devBranchCred = $creds | Where-Object { $_.subject -eq $expectedBranch }
            if ($devBranchCred) {
              Write-Host "âœ… $selectedEnv branch credential found: $($devBranchCred.name)" -ForegroundColor Green
            } else {
              Write-Host "âŒ $selectedEnv branch credential NOT found" -ForegroundColor Red
              Write-Host "Actual subjects found:" -ForegroundColor Yellow
              foreach ($cred in $creds) {
                Write-Host "  - $($cred.subject)" -ForegroundColor Yellow
              }
              Write-Error "âš ï¸ $selectedEnv branch federated credential is missing! Bootstrap will fail."
            }

            # Check environment credential for selected environment
            Write-Host "`nSearching for $selectedEnv environment credential..." -ForegroundColor Gray
            $expectedEnv = "repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:$selectedEnv"
            Write-Host "Expected: $expectedEnv" -ForegroundColor Gray
            $devEnvCred = $creds | Where-Object { $_.subject -eq $expectedEnv }
            if ($devEnvCred) {
              Write-Host "âœ… $selectedEnv environment credential found: $($devEnvCred.name)" -ForegroundColor Green
            } else {
              Write-Host "âŒ $selectedEnv environment credential NOT found" -ForegroundColor Red
            }
            
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "âœ… FEDERATED CREDENTIALS VERIFICATION COMPLETE" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING CREDENTIAL VERIFICATION" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
            Write-Error "Credential verification failed with exception: $($_.Exception.Message)"
            exit 1
          }

      - name: Create Setup Summary
        run: |
          "## ğŸ” Azure OIDC Setup Complete" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ğŸ“‹ Azure Credentials" >> $env:GITHUB_STEP_SUMMARY
          "- **Client ID**: ``${{ steps.oidc.outputs.clientId }}``" >> $env:GITHUB_STEP_SUMMARY
          "- **Tenant ID**: ``${{ steps.oidc.outputs.tenantId }}``" >> $env:GITHUB_STEP_SUMMARY
          "- **Subscription ID**: ``${{ steps.oidc.outputs.subscriptionId }}``" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ğŸ”‘ Next Steps - GitHub App Setup Required" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "#### Setup GitHub App (Zero Maintenance Authentication)" >> $env:GITHUB_STEP_SUMMARY
          "**Benefits**: âœ… Never expires â€¢ âœ… Auto-generated tokens â€¢ âœ… Better security" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "1. **Create GitHub App** - Quick 4-minute setup" >> $env:GITHUB_STEP_SUMMARY
          "   - ğŸ“– Step-by-step guide: [QUICK-SETUP-GITHUB-APP.md](../blob/main/Documentation/03-Configuration-Guides/QUICK-SETUP-GITHUB-APP.md)" >> $env:GITHUB_STEP_SUMMARY
          "   - ğŸ“˜ Detailed guide: [GITHUB-APP-AUTHENTICATION.md](../blob/main/Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md)" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "2. **Add 2 Repository Secrets**:" >> $env:GITHUB_STEP_SUMMARY
          "   - ``APP_ID`` - Your GitHub App ID" >> $env:GITHUB_STEP_SUMMARY
          "   - ``APP_PRIVATE_KEY`` - Private key (PEM format)" >> $env:GITHUB_STEP_SUMMARY
          "   - âœ¨ ``APP_INSTALLATION_ID`` - Auto-discovered!" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "3. **Re-run Workflow**" >> $env:GITHUB_STEP_SUMMARY
          "   - Enable: ``Configure GitHub secrets`` = true" >> $env:GITHUB_STEP_SUMMARY
          "   - Secrets will be automatically configured!" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "#### Alternative: Manual Configuration (No Automation)" >> $env:GITHUB_STEP_SUMMARY
          "If you prefer not to use automation, add these secrets manually:" >> $env:GITHUB_STEP_SUMMARY
          "- Go to: https://github.com/${{ github.repository }}/settings/secrets/actions" >> $env:GITHUB_STEP_SUMMARY
          "- Add:" >> $env:GITHUB_STEP_SUMMARY
          "  - ``AZUREAPPSERVICE_CLIENTID``: ``${{ steps.oidc.outputs.clientId }}``" >> $env:GITHUB_STEP_SUMMARY
          "  - ``AZUREAPPSERVICE_TENANTID``: ``${{ steps.oidc.outputs.tenantId }}``" >> $env:GITHUB_STEP_SUMMARY
          "  - ``AZUREAPPSERVICE_SUBSCRIPTIONID``: ``${{ steps.oidc.outputs.subscriptionId }}``" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ğŸ“¦ After Secrets Are Configured" >> $env:GITHUB_STEP_SUMMARY
          "Run this workflow again with ``Bootstrap infrastructure`` enabled" >> $env:GITHUB_STEP_SUMMARY

  setup-github-app:
    name: Setup GitHub App
    if: |
      always() &&
      inputs.setupGitHubApp &&
      !cancelled() &&
      needs.validate-inputs.result == 'success' &&
      (needs.setup-oidc.result == 'success' || needs.setup-oidc.result == 'skipped')
    needs: [validate-inputs, setup-oidc]
    runs-on: windows-latest
    environment: ${{ inputs.environment != 'all' && inputs.environment || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Explain GitHub App Setup
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         SETUP GITHUB APP - One-Time Configuration              â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "Repository: ${{ github.repository }}" -ForegroundColor Gray
          Write-Host ""
          Write-Host "ğŸ¯ Goal: Automated secret management with zero maintenance" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "Benefits:" -ForegroundColor Cyan
          Write-Host "  âœ… Tokens auto-generated (never expire)" -ForegroundColor Green
          Write-Host "  âœ… No manual renewal needed" -ForegroundColor Green
          Write-Host "  âœ… Better security (short-lived tokens)" -ForegroundColor Green
          Write-Host "  âœ… Full automation after initial setup" -ForegroundColor Green
          Write-Host ""
          Write-Host "âš ï¸  GitHub Security Requirement:" -ForegroundColor Yellow
          Write-Host "   For security, GitHub requires interactive authorization" -ForegroundColor Gray
          Write-Host "   for first-time app creation. This is by design." -ForegroundColor Gray
          Write-Host ""
          Write-Host "â±ï¸  One-time manual setup required (5 minutes)" -ForegroundColor Cyan
          Write-Host "   After this, everything is fully automated!" -ForegroundColor Green
          Write-Host ""

      - name: Check Existing GitHub App
        id: check-app
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "ğŸ” CHECKING GITHUB APP CONFIGURATION STATUS" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host ""
          Write-Host "ğŸ“‹ Required Secrets:" -ForegroundColor Yellow

          $hasAppId = "${{ secrets.APP_ID }}" -ne ""
          $hasPrivateKey = "${{ secrets.APP_PRIVATE_KEY }}" -ne ""

          Write-Host "  APP_ID                : $(if ($hasAppId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasAppId) { "Green" } else { "Red" })
          Write-Host "  APP_PRIVATE_KEY       : $(if ($hasPrivateKey) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasPrivateKey) { "Green" } else { "Red" })
          Write-Host ""
          Write-Host "â„¹ï¸  Note: APP_INSTALLATION_ID is no longer required - it will be auto-discovered!" -ForegroundColor Cyan
          Write-Host ""

          if ($hasAppId -and $hasPrivateKey) {
            Write-Host "âœ… GitHub App Configuration Status: COMPLETE" -ForegroundColor Green
            Write-Host ""
            Write-Host "  All required secrets are configured." -ForegroundColor Gray
            Write-Host "  Installation ID will be auto-discovered at runtime." -ForegroundColor Gray
            Write-Host "  No manual setup needed." -ForegroundColor Gray
            Write-Host "  Workflow will use the configured GitHub App for automation." -ForegroundColor Gray
            Write-Host ""
            "alreadyConfigured=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âŒ GitHub App Configuration Status: INCOMPLETE" -ForegroundColor Red
            Write-Host ""
            Write-Host "  One or more required secrets are missing." -ForegroundColor Gray
            Write-Host "  Manual setup is required to enable automation." -ForegroundColor Gray
            Write-Host ""
            "alreadyConfigured=false" >> $env:GITHUB_OUTPUT
          }
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host ""

      - name: Provide Setup Instructions
        if: steps.check-app.outputs.alreadyConfigured != 'true'
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Yellow
          Write-Host "â•‘         ğŸ“‹ GITHUB APP SETUP INSTRUCTIONS                       â•‘" -ForegroundColor Yellow
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "â±ï¸  Estimated time: 5 minutes" -ForegroundColor Gray
          Write-Host ""
          Write-Host "Step 1: Create GitHub App (2 minutes)" -ForegroundColor Cyan
          Write-Host "  ğŸ”— https://github.com/settings/apps/new" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "  Fill in:" -ForegroundColor White
          Write-Host "    Name: OrderProcessingSystem-SecretManager" -ForegroundColor Gray
          Write-Host "    Homepage: https://github.com/${{ github.repository }}" -ForegroundColor Gray
          Write-Host "    Webhook: UNCHECK 'Active'" -ForegroundColor Gray
          Write-Host ""
          Write-Host "  Permissions â†’ Repository permissions:" -ForegroundColor White
          Write-Host "    Secrets: Read and write âœ…" -ForegroundColor Gray
          Write-Host ""
          Write-Host "  Click 'Create GitHub App'" -ForegroundColor White
          Write-Host ""
          Write-Host "Step 2: Generate Private Key (30 seconds)" -ForegroundColor Cyan
          Write-Host "  After creation, scroll to 'Private keys' section" -ForegroundColor White
          Write-Host "  Click 'Generate a private key'" -ForegroundColor White
          Write-Host "  Save the downloaded .pem file" -ForegroundColor White
          Write-Host ""
          Write-Host "Step 3: Install App (30 seconds)" -ForegroundColor Cyan
          Write-Host "  Click 'Install App' in left sidebar" -ForegroundColor White
          Write-Host "  Select your account" -ForegroundColor White
          Write-Host "  Choose 'Only select repositories'" -ForegroundColor White
          Write-Host "  Select: ${{ github.repository }}" -ForegroundColor White
          Write-Host "  Click 'Install'" -ForegroundColor White
          Write-Host ""
          Write-Host "Step 4: Add Repository Secrets (1 minute)" -ForegroundColor Cyan
          Write-Host "  ğŸ”— https://github.com/${{ github.repository }}/settings/secrets/actions" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "  Add these 2 secrets (Installation ID auto-discovered):" -ForegroundColor White
          Write-Host ""
          Write-Host "    1. APP_ID" -ForegroundColor Cyan
          Write-Host "       Value: [App ID from app settings page]" -ForegroundColor Gray
          Write-Host ""
          Write-Host "    2. APP_PRIVATE_KEY" -ForegroundColor Cyan
          Write-Host "       Value: [Full contents of .pem file]" -ForegroundColor Gray
          Write-Host "       Note: Copy entire file including BEGIN/END lines" -ForegroundColor DarkGray
          Write-Host ""
          Write-Host "  âœ¨ Installation ID is automatically discovered - no manual input needed!" -ForegroundColor Green
          Write-Host ""
          Write-Host "Step 5: Re-run This Workflow" -ForegroundColor Cyan
          Write-Host "  After adding secrets, run this workflow again" -ForegroundColor White
          Write-Host "  Enable: 'Configure GitHub secrets' = true" -ForegroundColor White
          Write-Host "  The workflow will automatically use GitHub App" -ForegroundColor White
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
          Write-Host "âœ¨ After this one-time setup:" -ForegroundColor Green
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
          Write-Host "  âœ… Tokens auto-generate on every run" -ForegroundColor Green
          Write-Host "  âœ… No expiration to track" -ForegroundColor Green
          Write-Host "  âœ… No maintenance needed" -ForegroundColor Green
          Write-Host "  âœ… Fully automated forever!" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ“– Detailed guide:" -ForegroundColor Cyan
          Write-Host "   Documentation/03-Configuration-Guides/QUICK-SETUP-GITHUB-APP.md" -ForegroundColor White
          Write-Host ""

      - name: Create Setup Summary
        run: |
          "## ğŸ” GitHub App Setup" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY

          $hasApp = "${{ steps.check-app.outputs.alreadyConfigured }}" -eq "true"

          if ($hasApp) {
            "### âœ… Already Configured" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "GitHub App is already set up and ready to use." >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "**Configuration detected**:" >> $env:GITHUB_STEP_SUMMARY
            "- ``APP_ID`` âœ…" >> $env:GITHUB_STEP_SUMMARY
            "- ``APP_PRIVATE_KEY`` âœ…" >> $env:GITHUB_STEP_SUMMARY
            "- ``APP_INSTALLATION_ID`` âœ… (Auto-discovered)" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "**Next step**: Re-run workflow with ``Configure GitHub secrets`` enabled" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "### â±ï¸ One-Time Manual Setup Required (4 minutes)" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "GitHub's security model requires interactive authorization for app creation." >> $env:GITHUB_STEP_SUMMARY
            "This is a one-time setup that takes about 4 minutes." >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "### ğŸ“‹ Quick Setup Steps" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "1. **Create App** (2 min): https://github.com/settings/apps/new" >> $env:GITHUB_STEP_SUMMARY
            "   - Name: ``OrderProcessingSystem-SecretManager``" >> $env:GITHUB_STEP_SUMMARY
            "   - Permissions â†’ Secrets: Read and write" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "2. **Generate Key** (30 sec): Click 'Generate a private key', save .pem file" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "3. **Install App** (30 sec): Install on repository ${{ github.repository }}" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "4. **Add 2 Secrets** (1 min): https://github.com/${{ github.repository }}/settings/secrets/actions" >> $env:GITHUB_STEP_SUMMARY
            "   - ``APP_ID``" >> $env:GITHUB_STEP_SUMMARY
            "   - ``APP_PRIVATE_KEY``" >> $env:GITHUB_STEP_SUMMARY
            "   - âœ¨ ``APP_INSTALLATION_ID`` is auto-discovered!" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "5. **Re-run Workflow**: Enable 'Configure GitHub secrets'" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "### ğŸ“– Detailed Guide" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "[Quick Setup Guide](../blob/main/Documentation/03-Configuration-Guides/QUICK-SETUP-GITHUB-APP.md)" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "### âœ¨ After Setup" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… Tokens auto-generate forever" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… No expiration" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… No maintenance" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… Fully automated" >> $env:GITHUB_STEP_SUMMARY
          }

  configure-secrets:
    name: Configure GitHub Secrets
    if: |
      always() &&
      inputs.configureSecrets &&
      !cancelled() &&
      (needs.setup-oidc.result == 'success' || needs.setup-oidc.result == 'skipped') &&
      (needs.setup-github-app.result == 'success' || needs.setup-github-app.result == 'skipped')
    needs: [validate-inputs, setup-oidc, setup-github-app]
    runs-on: windows-latest
    environment: ${{ inputs.environment != 'all' && inputs.environment || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate Prerequisites
        id: prereqs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         VALIDATING PREREQUISITES                               â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸ” Checking OIDC setup status..." -ForegroundColor Cyan
            $setupOidc = "${{ inputs.setupOidc }}"
            $oidcJobResult = "${{ needs.setup-oidc.result }}"
            $hasClientId = "${{ needs.setup-oidc.outputs.clientId }}" -ne ""

            Write-Host "  OIDC Setup Enabled: $setupOidc" -ForegroundColor Gray
            Write-Host "  OIDC Job Result: $oidcJobResult" -ForegroundColor Gray
            Write-Host "  Client ID Present: $hasClientId" -ForegroundColor Gray
            Write-Host ""

            # Check if OIDC job failed or was cancelled
            if ($setupOidc -eq "true" -and $oidcJobResult -notin @("success", "skipped")) {
              Write-Host "  âŒ OIDC setup job did not complete successfully" -ForegroundColor Red
              Write-Host ""
              Write-Host "  Job Result: $oidcJobResult" -ForegroundColor Red
              Write-Host ""
              Write-Host "  Troubleshooting:" -ForegroundColor Yellow
              Write-Host "    1. Check the 'Setup Azure OIDC' job logs for errors" -ForegroundColor Gray
              Write-Host "    2. Ensure you completed the Azure device code authentication" -ForegroundColor Gray
              Write-Host "    3. Verify you have proper Azure permissions" -ForegroundColor Gray
              Write-Host "    4. Re-run the workflow with 'Setup Azure OIDC' enabled" -ForegroundColor Gray
              Write-Host ""
              Write-Error "OIDC setup job failed or was cancelled. Cannot proceed without OIDC credentials."
              exit 1
            }

            if ($setupOidc -eq "true" -and -not $hasClientId) {
              Write-Host "  âŒ OIDC setup was enabled but no client ID was output" -ForegroundColor Red
              Write-Host ""
              Write-Host "  This indicates the OIDC setup job completed but did not produce outputs." -ForegroundColor Red
              Write-Host ""
              Write-Host "  Troubleshooting:" -ForegroundColor Yellow
              Write-Host "    1. Review the 'Setup Azure OIDC' job logs" -ForegroundColor Gray
              Write-Host "    2. Verify the setup script ran successfully" -ForegroundColor Gray
              Write-Host "    3. Check if Azure app was created: '${{ inputs.oidcAppName }}'" -ForegroundColor Gray
              Write-Host "    4. Re-run the workflow with 'Setup Azure OIDC' enabled" -ForegroundColor Gray
              Write-Host ""
              Write-Error "OIDC setup was enabled but no client ID was output. Check setup-oidc job logs."
              exit 1
            }

            if ($setupOidc -eq "false" -and -not $hasClientId) {
              Write-Host "  âš ï¸  Running without OIDC setup" -ForegroundColor Yellow
              Write-Host "     Ensure Azure app credentials already exist in secrets." -ForegroundColor Gray
            } else {
              Write-Host "  âœ… OIDC credentials available" -ForegroundColor Green
            }
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING PREREQUISITE VALIDATION" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Error "Prerequisite validation failed: $($_.Exception.Message)"
            exit 1
          }

          Write-Host ""
          Write-Host "ğŸ” Checking GitHub App secrets..." -ForegroundColor Cyan
          Write-Host "  Environment Context: ${{ inputs.environment }}" -ForegroundColor Gray
          Write-Host ""
          
          # Check if GitHub App secrets are available
          $hasAppId = "${{ secrets.APP_ID }}" -ne ""
          $hasPrivateKey = "${{ secrets.APP_PRIVATE_KEY }}" -ne ""
          
          Write-Host "  APP_ID                : $(if ($hasAppId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasAppId) { "Green" } else { "Red" })
          Write-Host "  APP_PRIVATE_KEY       : $(if ($hasPrivateKey) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasPrivateKey) { "Green" } else { "Red" })
          Write-Host "  APP_INSTALLATION_ID   : âœ¨ Auto-discovered at runtime" -ForegroundColor Cyan
          Write-Host ""
          
          if ($hasAppId -and $hasPrivateKey) {
            Write-Host "  âœ… All required GitHub App secrets detected" -ForegroundColor Green
            "hasGitHubAppSecrets=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "  âš ï¸  GitHub App secrets not configured" -ForegroundColor Yellow
            Write-Host "     GitHub App setup is required for automated secret management." -ForegroundColor Gray
            "hasGitHubAppSecrets=false" >> $env:GITHUB_OUTPUT
          }
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "âœ… Prerequisite validation complete" -ForegroundColor Green
          Write-Host ""

      - name: Generate GitHub App Token
        id: app-token
        if: steps.prereqs.outputs.hasGitHubAppSecrets == 'true'
        # Allow this step to fail so we can provide helpful troubleshooting guidance
        # Most common cause of failure is GitHub App not installed on repository (404 error)
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      
      - name: Handle GitHub App Token Failure
        if: steps.prereqs.outputs.hasGitHubAppSecrets == 'true' && steps.app-token.outcome == 'failure'
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Red
          Write-Host "â•‘         GITHUB APP TOKEN GENERATION FAILED                    â•‘" -ForegroundColor Red
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Red
          Write-Host ""
          Write-Host "âŒ Failed to generate GitHub App installation token" -ForegroundColor Red
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
          Write-Host "ğŸ” MOST LIKELY CAUSE: GitHub App Not Installed on Repository" -ForegroundColor Yellow
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
          Write-Host ""
          Write-Host "The workflow detected APP_ID and APP_PRIVATE_KEY secrets, but failed" -ForegroundColor White
          Write-Host "to generate an installation token. This typically means:" -ForegroundColor White
          Write-Host ""
          Write-Host "  âŒ The GitHub App is created but NOT installed on this repository" -ForegroundColor Red
          Write-Host ""
          Write-Host "ğŸ“‹ SOLUTION: Install GitHub App on Repository" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Step 1: Verify GitHub App exists" -ForegroundColor Yellow
          Write-Host "  1. Go to: https://github.com/settings/apps" -ForegroundColor Gray
          Write-Host "  2. Find your app (e.g., 'OrderProcessingSystem-SecretManager')" -ForegroundColor Gray
          Write-Host "  3. If app doesn't exist, create it first (see setup guide below)" -ForegroundColor Gray
          Write-Host ""
          Write-Host "Step 2: Install the App on THIS Repository" -ForegroundColor Yellow
          Write-Host "  1. Go to: https://github.com/settings/installations" -ForegroundColor Gray
          Write-Host "  2. Find your app installation" -ForegroundColor Gray
          Write-Host "  3. Click 'Configure' next to the app" -ForegroundColor Gray
          Write-Host "  4. Under 'Repository access':" -ForegroundColor Gray
          Write-Host "     - Select 'Only select repositories'" -ForegroundColor Gray
          Write-Host "     - Add: ${{ github.repository }}" -ForegroundColor Gray
          Write-Host "  5. Click 'Save'" -ForegroundColor Gray
          Write-Host ""
          Write-Host "Step 3: Re-run This Workflow" -ForegroundColor Yellow
          Write-Host "  After installing the app, re-run this workflow with the same settings" -ForegroundColor Gray
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Yellow
          Write-Host "ğŸ“– OTHER POSSIBLE CAUSES (if app IS installed):" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "1. Wrong APP_ID Secret" -ForegroundColor White
          Write-Host "   - Current APP_ID: ${{ secrets.APP_ID }}" -ForegroundColor Gray
          Write-Host "   - Verify this matches your GitHub App ID" -ForegroundColor Gray
          Write-Host "   - Check at: https://github.com/settings/apps" -ForegroundColor Gray
          Write-Host ""
          Write-Host "2. Invalid APP_PRIVATE_KEY Format" -ForegroundColor White
          Write-Host "   - Must include BEGIN/END PRIVATE KEY lines" -ForegroundColor Gray
          Write-Host "   - Must be complete .pem file contents" -ForegroundColor Gray
          Write-Host "   - No extra spaces or line breaks" -ForegroundColor Gray
          Write-Host ""
          Write-Host "3. App Permissions Missing" -ForegroundColor White
          Write-Host "   - Required: Repository permissions â†’ Secrets: Read and write" -ForegroundColor Gray
          Write-Host "   - Check at: https://github.com/settings/apps â†’ Your App â†’ Permissions" -ForegroundColor Gray
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "ğŸ“š SETUP GUIDES:" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Quick Setup (4 minutes):" -ForegroundColor White
          Write-Host "  Documentation/03-Configuration-Guides/QUICK-SETUP-GITHUB-APP.md" -ForegroundColor Gray
          Write-Host ""
          Write-Host "Detailed Guide:" -ForegroundColor White
          Write-Host "  Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md" -ForegroundColor Gray
          Write-Host ""
          Write-Host "Installation ID Explained:" -ForegroundColor White
          Write-Host "  APP_INSTALLATION_ID_EXPLAINED.md" -ForegroundColor Gray
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host ""
          Write-Host "ğŸ’¡ Quick Check:" -ForegroundColor Yellow
          Write-Host "   Visit: https://github.com/settings/installations" -ForegroundColor White
          Write-Host "   Does your app show '${{ github.repository }}' in its repository list?" -ForegroundColor White
          Write-Host "   If NO â†’ Install the app on this repository (steps above)" -ForegroundColor White
          Write-Host "   If YES â†’ Check APP_ID and APP_PRIVATE_KEY secrets are correct" -ForegroundColor White
          Write-Host ""
          
          Write-Error "GitHub App token generation failed. Please install the GitHub App on this repository and try again."

      - name: Check Required Secrets
        id: check
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          APP_ID: ${{ secrets.APP_ID }}
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         REPOSITORY SECRET VALIDATION                          â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          # Check existing Azure secrets
          $hasClientId = "${{ secrets.AZUREAPPSERVICE_CLIENTID }}" -ne ""
          $hasTenantId = "${{ secrets.AZUREAPPSERVICE_TENANTID }}" -ne ""
          $hasSubscriptionId = "${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}" -ne ""
          
          Write-Host "ğŸ“‹ Azure Secret Status:" -ForegroundColor Yellow
          Write-Host "  AZUREAPPSERVICE_CLIENTID       : $(if ($hasClientId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasClientId) { "Green" } else { "Red" })
          Write-Host "  AZUREAPPSERVICE_TENANTID       : $(if ($hasTenantId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasTenantId) { "Green" } else { "Red" })
          Write-Host "  AZUREAPPSERVICE_SUBSCRIPTIONID : $(if ($hasSubscriptionId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasSubscriptionId) { "Green" } else { "Red" })
          Write-Host ""
          
          # Check GitHub App authentication (REQUIRED for automated secret management)
          Write-Host "ğŸ” GitHub App Authentication:" -ForegroundColor Yellow
          if ($env:GH_APP_TOKEN) {
            Write-Host "  âœ… Status: AUTHENTICATED" -ForegroundColor Green
            Write-Host "  â„¹ï¸  App ID: $env:APP_ID" -ForegroundColor Gray
            Write-Host "  â„¹ï¸  Token: Generated (expires in 1 hour, auto-renewed)" -ForegroundColor Gray
            Write-Host "  â„¹ï¸  Permissions: Secrets read/write" -ForegroundColor Gray
            "useGitHubApp=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "  âŒ Status: NOT AUTHENTICATED" -ForegroundColor Red
            Write-Host ""
            Write-Host "  ERROR: GitHub App is required for secret automation" -ForegroundColor Red
            Write-Host ""
            Write-Host "  ğŸ“– Troubleshooting Steps:" -ForegroundColor Yellow
            Write-Host "     1. Verify GitHub App secrets are configured:" -ForegroundColor White
            Write-Host "        - APP_ID" -ForegroundColor Gray
            Write-Host "        - APP_PRIVATE_KEY" -ForegroundColor Gray
            Write-Host "        - APP_INSTALLATION_ID (auto-discovered)" -ForegroundColor Gray
            Write-Host ""
            Write-Host "     2. Check secret configuration at:" -ForegroundColor White
            Write-Host "        https://github.com/${{ github.repository }}/settings/secrets/actions" -ForegroundColor Gray
            Write-Host ""
            Write-Host "     3. Setup guide:" -ForegroundColor White
            Write-Host "        Documentation/03-Configuration-Guides/QUICK-SETUP-GITHUB-APP.md" -ForegroundColor Gray
            Write-Host ""
            Write-Host "     4. If secrets exist, check GitHub App installation:" -ForegroundColor White
            Write-Host "        https://github.com/settings/installations" -ForegroundColor Gray
            Write-Host ""
            "useGitHubApp=false" >> $env:GITHUB_OUTPUT
          }
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          
          if ($hasClientId -and $hasTenantId -and $hasSubscriptionId) {
            Write-Host "âœ… All Azure secrets already configured - skipping secret setup" -ForegroundColor Green
            "secretsExist=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âš ï¸  Azure secrets missing - will attempt configuration" -ForegroundColor Yellow
            "secretsExist=false" >> $env:GITHUB_OUTPUT
          }
          Write-Host ""
      
      - name: Validate GitHub App Token
        if: steps.check.outputs.useGitHubApp != 'true'
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Red
          Write-Host "â•‘                  AUTHENTICATION FAILURE                        â•‘" -ForegroundColor Red
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Red
          Write-Host ""
          Write-Host "âŒ GitHub App authentication is REQUIRED for this workflow" -ForegroundColor Red
          Write-Host ""
          Write-Host "GitHub Apps provide better security and zero maintenance." -ForegroundColor Yellow
          Write-Host ""
          Write-Host "ğŸ“‹ Required Action:" -ForegroundColor Cyan
          Write-Host "  1. Follow the setup guide:" -ForegroundColor White
          Write-Host "     Documentation/03-Configuration-Guides/QUICK-SETUP-GITHUB-APP.md" -ForegroundColor Gray
          Write-Host ""
          Write-Host "  2. Create GitHub App (4 minutes):" -ForegroundColor White
          Write-Host "     https://github.com/settings/apps/new" -ForegroundColor Gray
          Write-Host ""
          Write-Host "  3. Add these 2 repository secrets:" -ForegroundColor White
          Write-Host "     - APP_ID" -ForegroundColor Gray
          Write-Host "     - APP_PRIVATE_KEY" -ForegroundColor Gray
          Write-Host "     âœ¨ APP_INSTALLATION_ID is auto-discovered!" -ForegroundColor Green
          Write-Host ""
          Write-Host "  4. Re-run this workflow" -ForegroundColor White
          Write-Host ""
          Write-Host "For troubleshooting, see:" -ForegroundColor Cyan
          Write-Host "  Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md" -ForegroundColor Gray
          Write-Host ""
          
          Write-Error "GitHub App authentication required. Cannot proceed without proper authentication."
          exit 1

      - name: Set Repository Secrets
        if: steps.check.outputs.secretsExist == 'false' && steps.check.outputs.useGitHubApp == 'true'
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId }}
          TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId }}
          SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId }}
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘           REPOSITORY SECRET CONFIGURATION                     â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "Authentication: GitHub App" -ForegroundColor Green
          Write-Host "Repository: ${{ github.repository }}" -ForegroundColor Gray
          Write-Host ""
          
          # Validate required values
          Write-Host "ğŸ“‹ Validating input values..." -ForegroundColor Yellow
          $validationErrors = @()
          
          if (-not $env:CLIENT_ID) { $validationErrors += "CLIENT_ID is empty" }
          if (-not $env:TENANT_ID) { $validationErrors += "TENANT_ID is empty" }
          if (-not $env:SUBSCRIPTION_ID) { $validationErrors += "SUBSCRIPTION_ID is empty" }
          if (-not $env:GH_APP_TOKEN) { $validationErrors += "GH_APP_TOKEN is empty" }
          
          if ($validationErrors.Count -gt 0) {
            Write-Host ""
            Write-Host "âŒ Validation Errors:" -ForegroundColor Red
            foreach ($error in $validationErrors) {
              Write-Host "   - $error" -ForegroundColor Red
            }
            Write-Host ""
            Write-Host "Troubleshooting:" -ForegroundColor Yellow
            Write-Host "  1. Ensure OIDC setup was successful" -ForegroundColor Gray
            Write-Host "  2. Check setup-oidc job outputs" -ForegroundColor Gray
            Write-Host "  3. Verify GitHub App token was generated" -ForegroundColor Gray
            Write-Error "Required values are missing. Cannot configure secrets."
            exit 1
          }
          
          Write-Host "  âœ… All required values present" -ForegroundColor Green
          Write-Host ""
          
          # Set GH_TOKEN for gh CLI
          $env:GH_TOKEN = $env:GH_APP_TOKEN
          
          Write-Host "ğŸ”‘ Configuring Azure secrets..." -ForegroundColor Cyan
          Write-Host ""
          
          # Configure each secret with error handling
          $secrets = @{
            "AZUREAPPSERVICE_CLIENTID" = $env:CLIENT_ID
            "AZUREAPPSERVICE_TENANTID" = $env:TENANT_ID
            "AZUREAPPSERVICE_SUBSCRIPTIONID" = $env:SUBSCRIPTION_ID
          }
          
          $successCount = 0
          $failCount = 0
          
          foreach ($secretName in $secrets.Keys) {
            Write-Host "  Setting: $secretName" -ForegroundColor Gray
            try {
              gh secret set $secretName --repo ${{ github.repository }} --body $secrets[$secretName] 2>&1 | Out-Null
              if ($LASTEXITCODE -eq 0) {
                Write-Host "    âœ… Success" -ForegroundColor Green
                $successCount++
              } else {
                Write-Host "    âŒ Failed (exit code: $LASTEXITCODE)" -ForegroundColor Red
                $failCount++
              }
            } catch {
              Write-Host "    âŒ Exception: $($_.Exception.Message)" -ForegroundColor Red
              $failCount++
            }
          }
          
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "Configuration Summary:" -ForegroundColor Cyan
          Write-Host "  âœ… Successful: $successCount" -ForegroundColor Green
          if ($failCount -gt 0) {
            Write-Host "  âŒ Failed: $failCount" -ForegroundColor Red
          }
          Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          if ($failCount -gt 0) {
            Write-Host "Troubleshooting:" -ForegroundColor Yellow
            Write-Host "  1. Check GitHub App permissions (Secrets: Read and write)" -ForegroundColor Gray
            Write-Host "  2. Verify app is installed on repository: https://github.com/settings/installations" -ForegroundColor Gray
            Write-Host "  3. Review GitHub App configuration: Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md" -ForegroundColor Gray
            Write-Error "Failed to set $failCount secret(s). See logs above for details."
            exit 1
          }
          
          Write-Host "âœ… All repository secrets configured successfully!" -ForegroundColor Green
          Write-Host ""

      - name: Set Environment Secrets
        if: steps.check.outputs.secretsExist == 'false' && steps.check.outputs.useGitHubApp == 'true'
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId }}
          TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId }}
          SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId }}
        run: |
          $selectedEnv = "${{ inputs.environment }}"
          
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘        ENVIRONMENT SECRET CONFIGURATION                       â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "Target Selection: $selectedEnv" -ForegroundColor Gray
          Write-Host "Authentication: GitHub App" -ForegroundColor Green
          Write-Host ""
          
          # Validate GitHub App token
          if (-not $env:GH_APP_TOKEN) {
            Write-Host "âŒ GitHub App token not available" -ForegroundColor Red
            Write-Host "Cannot configure environment secrets without authentication" -ForegroundColor Red
            Write-Error "GitHub App authentication required for environment secrets"
            exit 1
          }
          
          # Set GH_TOKEN for gh CLI commands
          $env:GH_TOKEN = $env:GH_APP_TOKEN
          
          # Determine which environments to configure
          $environments = @()
          if ($selectedEnv -eq "all") {
            $environments = @("dev", "staging", "prod")
          } else {
            $environments = @($selectedEnv)
          }
          
          Write-Host "ğŸ”‘ Configuring environment secrets for: $($environments -join ', ')" -ForegroundColor Cyan
          Write-Host ""
          
          $ownerRepo = "${{ github.repository }}"
          $owner, $repo = $ownerRepo -split '/', 2
          $totalSuccess = 0
          $totalFail = 0
          
          foreach ($env_name in $environments) {
            Write-Host "  Environment: $env_name" -ForegroundColor Yellow
            
            # First, ensure the environment exists - create it if it doesn't
            Write-Host "    Checking if environment exists..." -ForegroundColor Gray
            try {
              gh api -H "Accept: application/vnd.github+json" "repos/$owner/$repo/environments/$env_name" 2>&1 | Out-Null
              if ($LASTEXITCODE -eq 0) {
                Write-Host "      âœ… Environment exists" -ForegroundColor Green
              } else {
                Write-Host "      âš ï¸  Environment doesn't exist, creating it..." -ForegroundColor Yellow
                # Create the environment using GitHub API
                gh api --method PUT -H "Accept: application/vnd.github+json" "repos/$owner/$repo/environments/$env_name" 2>&1 | Out-Null
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "      âœ… Environment created successfully" -ForegroundColor Green
                } else {
                  Write-Host "      âš ï¸  Could not create environment (may need admin permission)" -ForegroundColor Yellow
                  Write-Host "      Skipping environment secrets for $env_name" -ForegroundColor Yellow
                  Write-Host ""
                  continue
                }
              }
            } catch {
              Write-Host "      âš ï¸  Could not check environment: $($_.Exception.Message)" -ForegroundColor Yellow
              Write-Host "      Skipping environment secrets for $env_name" -ForegroundColor Yellow
              Write-Host ""
              continue
            }
            
            # Set environment secrets
            $secretsToSet = @{
              "AZUREAPPSERVICE_CLIENTID" = $env:CLIENT_ID
              "AZUREAPPSERVICE_TENANTID" = $env:TENANT_ID
              "AZUREAPPSERVICE_SUBSCRIPTIONID" = $env:SUBSCRIPTION_ID
            }
            
            foreach ($secretName in $secretsToSet.Keys) {
              Write-Host "    Setting: $secretName" -ForegroundColor Gray
              try {
                gh secret set $secretName --env $env_name --repo $ownerRepo --body $secretsToSet[$secretName] 2>&1 | Out-Null
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "      âœ… Success" -ForegroundColor Green
                  $totalSuccess++
                } else {
                  Write-Host "      âŒ Failed (exit code: $LASTEXITCODE)" -ForegroundColor Red
                  $totalFail++
                }
              } catch {
                Write-Host "      âŒ Exception: $($_.Exception.Message)" -ForegroundColor Red
                $totalFail++
              }
            }
            Write-Host ""
          }
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "Configuration Summary:" -ForegroundColor Cyan
          Write-Host "  âœ… Successful: $totalSuccess" -ForegroundColor Green
          if ($totalFail -gt 0) {
            Write-Host "  âŒ Failed: $totalFail" -ForegroundColor Red
          }
          Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          if ($totalFail -gt 0) {
            Write-Host "âš ï¸  Some environment secrets failed to set" -ForegroundColor Yellow
            Write-Host ""
            Write-Host "Note: Repository secrets were successfully configured." -ForegroundColor Green
            Write-Host "Environment-specific secrets are optional and only needed if you use" -ForegroundColor Gray
            Write-Host "different credentials per environment. The workflows can use repository" -ForegroundColor Gray
            Write-Host "secrets which are available to all environments." -ForegroundColor Gray
            Write-Host ""
            Write-Host "If you need environment-specific secrets:" -ForegroundColor Cyan
            Write-Host "  1. Verify environments exist: https://github.com/$owner/$repo/settings/environments" -ForegroundColor Gray
            Write-Host "  2. Check GitHub App has admin permission to create environments" -ForegroundColor Gray
            Write-Host "  3. Or manually create environments and re-run this workflow" -ForegroundColor Gray
            Write-Host ""
            # Don't fail the workflow - repository secrets are sufficient
            Write-Warning "Environment secrets partially configured. Repository secrets are available and sufficient for deployment."
          } else {
            Write-Host "âœ… All environment secrets configured successfully!" -ForegroundColor Green
          }
          Write-Host ""
      
      - name: Verify Repository Secrets
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘           REPOSITORY SECRET VERIFICATION                      â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          
          # Use GitHub App token or fall back to GITHUB_TOKEN (read-only)
          if ($env:GH_APP_TOKEN) {
            $env:GH_TOKEN = $env:GH_APP_TOKEN
            Write-Host "Authentication: GitHub App" -ForegroundColor Green
          } else {
            $env:GH_TOKEN = "${{ secrets.GITHUB_TOKEN }}"
            Write-Host "Authentication: GITHUB_TOKEN (read-only)" -ForegroundColor Yellow
          }
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "ğŸ” Verifying Azure secrets..." -ForegroundColor Cyan
          Write-Host ""
          
          $ownerRepo = "${{ github.repository }}"
          $owner, $repo = $ownerRepo -split '/', 2
          
          try {
            $respJson = gh api -H "Accept: application/vnd.github+json" repos/$owner/$repo/actions/secrets 2>$null
            if ($LASTEXITCODE -ne 0 -or -not $respJson) {
              Write-Host "âŒ Failed to fetch repository secrets via GitHub API" -ForegroundColor Red
              Write-Error "API call failed with exit code: $LASTEXITCODE"
              exit 1
            }
            
            $resp = $respJson | ConvertFrom-Json
            $names = @()
            if ($resp -and $resp.secrets) { $names = $resp.secrets | ForEach-Object { $_.name } }
            
            $requiredSecrets = @("AZUREAPPSERVICE_CLIENTID", "AZUREAPPSERVICE_TENANTID", "AZUREAPPSERVICE_SUBSCRIPTIONID")
            $allPresent = $true
            
            foreach ($secretName in $requiredSecrets) {
              if ($names -contains $secretName) {
                Write-Host "  âœ… $secretName" -ForegroundColor Green
              } else {
                Write-Host "  âŒ $secretName - MISSING" -ForegroundColor Red
                $allPresent = $false
              }
            }
            
            # Add to job summary
            "" >> $env:GITHUB_STEP_SUMMARY
            "### ğŸ”‘ Repository Secrets Verification" >> $env:GITHUB_STEP_SUMMARY
            "**Required Azure Secrets:**" >> $env:GITHUB_STEP_SUMMARY
            foreach ($secretName in $requiredSecrets) {
              $status = if ($names -contains $secretName) { "âœ…" } else { "âŒ" }
              "- $status ``$secretName``" >> $env:GITHUB_STEP_SUMMARY
            }
            "" >> $env:GITHUB_STEP_SUMMARY
            
            if (-not $allPresent) {
              Write-Host ""
              Write-Host "âŒ Verification Failed - Required secrets missing" -ForegroundColor Red
              Write-Error "One or more required repository secrets are missing. See logs and summary for details."
              exit 1
            }
            
            Write-Host ""
            Write-Host "âœ… All required repository secrets verified successfully" -ForegroundColor Green
            
          } catch {
            Write-Host "âŒ Exception during verification: $($_.Exception.Message)" -ForegroundColor Red
            Write-Error "Failed to verify repository secrets"
            exit 1
          }
          
          Write-Host ""
          Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
      
      - name: Verify Environment Secrets
        env:
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘        ENVIRONMENT SECRET VERIFICATION                        â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          
          # Check if GitHub App token is available
          if (-not $env:GH_APP_TOKEN) {
            Write-Host "âš ï¸  GitHub App token not available - skipping environment secret verification" -ForegroundColor Yellow
            Write-Host "Environment secrets can only be verified with GitHub App authentication" -ForegroundColor Yellow
            Write-Host ""
            exit 0
          }
          
          $env:GH_TOKEN = $env:GH_APP_TOKEN
          Write-Host "Authentication: GitHub App" -ForegroundColor Green
          Write-Host ""
          
          $selectedEnv = "${{ inputs.environment }}"
          $environments = @()
          if ($selectedEnv -eq "all") {
            $environments = @("dev", "staging", "prod")
          } else {
            $environments = @($selectedEnv)
          }
          
          Write-Host "ğŸ” Verifying environment secrets for: $($environments -join ', ')" -ForegroundColor Cyan
          Write-Host ""
          
          $ownerRepo = "${{ github.repository }}"
          $owner, $repo = $ownerRepo -split '/', 2
          $allVerified = $true
          
          foreach ($env_name in $environments) {
            Write-Host "  Environment: $env_name" -ForegroundColor Yellow
            
            try {
              $respJson = gh api -H "Accept: application/vnd.github+json" repos/$owner/$repo/environments/$env_name/secrets 2>$null
              
              if ($LASTEXITCODE -ne 0 -or -not $respJson) {
                Write-Host "    âš ï¸  Could not fetch secrets (environment may not exist)" -ForegroundColor Yellow
                continue
              }
              
              $resp = $respJson | ConvertFrom-Json
              $names = @()
              if ($resp -and $resp.secrets) {
                $names = $resp.secrets | ForEach-Object { $_.name }
              }
              
              $requiredSecrets = @("AZUREAPPSERVICE_CLIENTID", "AZUREAPPSERVICE_TENANTID", "AZUREAPPSERVICE_SUBSCRIPTIONID")
              
              foreach ($secretName in $requiredSecrets) {
                if ($names -contains $secretName) {
                  Write-Host "    âœ… $secretName" -ForegroundColor Green
                } else {
                  Write-Host "    âŒ $secretName - MISSING" -ForegroundColor Red
                  $allVerified = $false
                }
              }
              
              # Add to job summary
              "" >> $env:GITHUB_STEP_SUMMARY
              "### ğŸ”‘ Environment Secrets: $env_name" >> $env:GITHUB_STEP_SUMMARY
              foreach ($secretName in $requiredSecrets) {
                $status = if ($names -contains $secretName) { "âœ…" } else { "âŒ" }
                "- $status ``$secretName``" >> $env:GITHUB_STEP_SUMMARY
              }
              
            } catch {
              Write-Host "    âš ï¸  Exception: $($_.Exception.Message)" -ForegroundColor Yellow
            }
            Write-Host ""
          }
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          
          if ($allVerified) {
            Write-Host "âœ… All environment secrets verified successfully" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸  Some environment secrets may be missing - review logs above" -ForegroundColor Yellow
          }
          
          Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          # Exit with 0 to ensure script success even if gh commands had non-zero exit codes
          # Environment secret verification is informational; missing environments are expected during initial setup
          exit 0
  
  pre-validate-prerequisites:
    name: Pre-Validate Prerequisites
    if: |
      always() &&
      !cancelled() &&
      (inputs.bootstrapInfra || inputs.enableValidation) &&
      needs.validate-inputs.result == 'success'
    needs: [validate-inputs, setup-oidc, setup-github-app, configure-secrets]
    runs-on: windows-latest
    environment: ${{ inputs.environment != 'all' && inputs.environment || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate Prerequisites
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         PRE-VALIDATE PREREQUISITES                             â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          Write-Host "â„¹ï¸  Environment: ${{ inputs.environment }}" -ForegroundColor Cyan
          Write-Host "â„¹ï¸  Validation Context: ${{ inputs.environment != 'all' && inputs.environment || 'dev' }}" -ForegroundColor Cyan
          if ("${{ inputs.environment }}" -eq "all") {
            Write-Host "âš ï¸  Note: Validating with 'dev' environment context" -ForegroundColor Yellow
            Write-Host "   Ensure secrets are available in repository or all target environments" -ForegroundColor Gray
          }
          Write-Host ""
          
          # Check if setup steps were executed or skipped
          $oidcSetupRan = "${{ needs.setup-oidc.result }}" -eq "success"
          $githubAppSetupRan = "${{ needs.setup-github-app.result }}" -eq "success"
          
          Write-Host "ğŸ“‹ Previous Step Results:" -ForegroundColor Cyan
          Write-Host "  Setup OIDC: ${{ needs.setup-oidc.result }}" -ForegroundColor Gray
          Write-Host "  Setup GitHub App: ${{ needs.setup-github-app.result }}" -ForegroundColor Gray
          Write-Host "  Configure Secrets: ${{ needs.configure-secrets.result }}" -ForegroundColor Gray
          Write-Host ""
          
          $hasErrors = $false
          
          Write-Host "ğŸ” Validating OIDC App Configuration..." -ForegroundColor Cyan
          Write-Host ""
          
          # Check if OIDC secrets exist
          $hasClientId = "${{ secrets.AZUREAPPSERVICE_CLIENTID }}" -ne ""
          $hasTenantId = "${{ secrets.AZUREAPPSERVICE_TENANTID }}" -ne ""
          $hasSubscriptionId = "${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}" -ne ""
          
          if ($hasClientId -and $hasTenantId -and $hasSubscriptionId) {
            Write-Host "  âœ… OIDC credentials are configured" -ForegroundColor Green
          } else {
            Write-Host "  âŒ OIDC credentials are missing or incomplete" -ForegroundColor Red
            Write-Host "     Missing:" -ForegroundColor Yellow
            if (-not $hasClientId) { Write-Host "       - AZUREAPPSERVICE_CLIENTID" -ForegroundColor Red }
            if (-not $hasTenantId) { Write-Host "       - AZUREAPPSERVICE_TENANTID" -ForegroundColor Red }
            if (-not $hasSubscriptionId) { Write-Host "       - AZUREAPPSERVICE_SUBSCRIPTIONID" -ForegroundColor Red }
            Write-Host ""
            if ($oidcSetupRan) {
              Write-Host "  âš ï¸  OIDC setup ran but secrets are not accessible in this environment" -ForegroundColor Yellow
              Write-Host "     This may indicate secrets were configured in a different environment" -ForegroundColor Gray
            } else {
              Write-Host "  ğŸ’¡ Solution: Run this workflow with 'Setup Azure OIDC' enabled" -ForegroundColor Yellow
            }
            $hasErrors = $true
          }
          
          Write-Host ""
          Write-Host "ğŸ” Validating GitHub App Configuration..." -ForegroundColor Cyan
          Write-Host ""
          
          # Check if GitHub App secrets exist
          $hasAppId = "${{ secrets.APP_ID }}" -ne ""
          $hasPrivateKey = "${{ secrets.APP_PRIVATE_KEY }}" -ne ""
          
          if ($hasAppId -and $hasPrivateKey) {
            Write-Host "  âœ… GitHub App credentials are configured" -ForegroundColor Green
            Write-Host "     - APP_ID: Present" -ForegroundColor Gray
            Write-Host "     - APP_PRIVATE_KEY: Present" -ForegroundColor Gray
            Write-Host "     - APP_INSTALLATION_ID: Auto-discovered at runtime" -ForegroundColor Gray
          } else {
            Write-Host "  âŒ GitHub App credentials are missing or incomplete" -ForegroundColor Red
            Write-Host "     Missing:" -ForegroundColor Yellow
            if (-not $hasAppId) { Write-Host "       - APP_ID" -ForegroundColor Red }
            if (-not $hasPrivateKey) { Write-Host "       - APP_PRIVATE_KEY" -ForegroundColor Red }
            Write-Host ""
            if ($githubAppSetupRan) {
              Write-Host "  âš ï¸  GitHub App setup completed but secrets are not accessible" -ForegroundColor Yellow
              Write-Host "     This may indicate secrets were configured in a different environment" -ForegroundColor Gray
            } else {
              Write-Host "  ğŸ’¡ Solution: Run this workflow with 'Setup GitHub App' enabled" -ForegroundColor Yellow
              Write-Host "     Or manually configure GitHub App secrets" -ForegroundColor Yellow
            }
            $hasErrors = $true
          }
          
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          
          if ($hasErrors) {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ VALIDATION FAILED: Prerequisites are not met" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Bootstrap cannot proceed without the required prerequisites." -ForegroundColor Red
            Write-Host "Please review the validation results above." -ForegroundColor Red
            Write-Host ""
            Write-Host "Required Actions:" -ForegroundColor Cyan
            Write-Host "  1. Ensure OIDC credentials are configured" -ForegroundColor White
            Write-Host "     - Run this workflow with 'Setup Azure OIDC' enabled" -ForegroundColor White
            Write-Host "  2. Ensure GitHub App credentials are configured" -ForegroundColor White
            Write-Host "     - Run this workflow with 'Setup GitHub App' enabled" -ForegroundColor White
            Write-Host "     - Or manually configure APP_ID and APP_PRIVATE_KEY secrets" -ForegroundColor White
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
            Write-Error "Prerequisites validation failed. Cannot proceed with bootstrap."
            exit 1
          } else {
            Write-Host "âœ… All prerequisites validated successfully" -ForegroundColor Green
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }

      - name: Create Validation Summary
        if: always()
        run: |
          "## ğŸ” Pre-Validation Results" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          
          $hasClientId = "${{ secrets.AZUREAPPSERVICE_CLIENTID }}" -ne ""
          $hasTenantId = "${{ secrets.AZUREAPPSERVICE_TENANTID }}" -ne ""
          $hasSubscriptionId = "${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}" -ne ""
          $hasAppId = "${{ secrets.APP_ID }}" -ne ""
          $hasPrivateKey = "${{ secrets.APP_PRIVATE_KEY }}" -ne ""
          
          $allValid = ($hasClientId -and $hasTenantId -and $hasSubscriptionId) -and ($hasAppId -and $hasPrivateKey)
          
          if (-not $allValid) {
            "### âŒ Validation Failed" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "Prerequisites are missing. Bootstrap cannot proceed." >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
          }
          
          "### Azure OIDC Configuration" >> $env:GITHUB_STEP_SUMMARY
          if ($hasClientId -and $hasTenantId -and $hasSubscriptionId) {
            "âœ… **Status**: Configured" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "âŒ **Status**: Missing or incomplete - **REQUIRED**" >> $env:GITHUB_STEP_SUMMARY
          }
          "" >> $env:GITHUB_STEP_SUMMARY
          
          "### GitHub App Configuration" >> $env:GITHUB_STEP_SUMMARY
          if ($hasAppId -and $hasPrivateKey) {
            "âœ… **Status**: Configured" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "âŒ **Status**: Missing or incomplete - **REQUIRED**" >> $env:GITHUB_STEP_SUMMARY
          }
  
  bootstrap-dev:
    name: Bootstrap Dev Environment
    if: |
      always() &&
      inputs.bootstrapInfra &&
      (inputs.environment == 'dev' || inputs.environment == 'all') &&
      !cancelled() &&
      (needs.setup-oidc.result == 'success' || needs.setup-oidc.result == 'skipped') &&
      (needs.configure-secrets.result == 'success' || needs.configure-secrets.result == 'skipped') &&
      (needs.pre-validate-prerequisites.result == 'success' || needs.pre-validate-prerequisites.result == 'skipped')
    needs: [setup-oidc, configure-secrets, pre-validate-prerequisites]
    runs-on: windows-latest
    environment: dev
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate GitHub App Token
        id: app-token
        if: ${{ env.APP_ID != '' }}
        continue-on-error: true
        env:
          APP_ID: ${{ secrets.APP_ID }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      
      - name: Validate Azure Credentials
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         VALIDATE AZURE CREDENTIALS - DEV                      â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸ” Checking Azure credentials..." -ForegroundColor Cyan
            
            $hasClientId = -not [string]::IsNullOrWhiteSpace($env:CLIENT_ID)
            $hasTenantId = -not [string]::IsNullOrWhiteSpace($env:TENANT_ID)
            $hasSubscriptionId = -not [string]::IsNullOrWhiteSpace($env:SUBSCRIPTION_ID)
            
            Write-Host "  CLIENT_ID:         $(if ($hasClientId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasClientId) { "Green" } else { "Red" })
            Write-Host "  TENANT_ID:         $(if ($hasTenantId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasTenantId) { "Green" } else { "Red" })
            Write-Host "  SUBSCRIPTION_ID:   $(if ($hasSubscriptionId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasSubscriptionId) { "Green" } else { "Red" })
            Write-Host ""
            
            if (-not $hasClientId -or -not $hasTenantId -or -not $hasSubscriptionId) {
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ AZURE CREDENTIALS MISSING" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Required credentials are not available." -ForegroundColor Red
              Write-Host ""
              Write-Host "Troubleshooting:" -ForegroundColor Yellow
              Write-Host "  1. Ensure 'Setup Azure OIDC' job completed successfully" -ForegroundColor Gray
              Write-Host "  2. OR ensure secrets are configured:" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_CLIENTID" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_TENANTID" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_SUBSCRIPTIONID" -ForegroundColor Gray
              Write-Host "  3. Re-run workflow with 'Setup Azure OIDC' = true" -ForegroundColor Gray
              Write-Host ""
              Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
              exit 1
            }
            
            Write-Host "âœ… All Azure credentials validated successfully" -ForegroundColor Green
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING CREDENTIAL VALIDATION" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Error "Credential validation failed: $($_.Exception.Message)"
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      
      - name: Verify Azure Login
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         VERIFY AZURE LOGIN - DEV                              â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          
          try {
            Write-Host "ğŸ” Verifying Azure login..." -ForegroundColor Cyan
            $account = az account show | ConvertFrom-Json
            
            if ($LASTEXITCODE -ne 0 -or -not $account) {
              Write-Host "âŒ Azure login verification failed" -ForegroundColor Red
              Write-Error "Failed to verify Azure login"
              exit 1
            }
            
            Write-Host "âœ… Azure login verified successfully" -ForegroundColor Green
            Write-Host ""
            Write-Host "Account Details:" -ForegroundColor Yellow
            Write-Host "  Subscription: $($account.name)" -ForegroundColor Gray
            Write-Host "  Subscription ID: $($account.id)" -ForegroundColor Gray
            Write-Host "  Tenant ID: $($account.tenantId)" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host "âŒ Exception during Azure login verification: $($_.Exception.Message)" -ForegroundColor Red
            Write-Error "Failed to verify Azure login: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Bootstrap Dev Infrastructure
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         BOOTSTRAP DEV INFRASTRUCTURE                          â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸš€ Bootstrapping Dev Environment..." -ForegroundColor Cyan
          Write-Host "" -ForegroundColor Gray
          Write-Host "ğŸ“‹ Configuration:" -ForegroundColor Yellow
          Write-Host "  Branch: dev" -ForegroundColor Gray
          Write-Host "  Environment: dev" -ForegroundColor Gray
          Write-Host "  Parameter File: infra/parameters/dev.json" -ForegroundColor Gray
          Write-Host "  Resource Group: rg-orderprocessing-dev" -ForegroundColor Gray
          Write-Host "  OIDC Subject: repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/dev" -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host ""

          ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment dev
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ BOOTSTRAP SCRIPT FAILED" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exit Code: $LASTEXITCODE" -ForegroundColor Red
            Write-Host "Script: ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1" -ForegroundColor Gray
            Write-Host "Environment: dev" -ForegroundColor Gray
            Write-Host ""
            Write-Host "Check the bootstrap log artifact for detailed error information." -ForegroundColor Yellow
            Write-Host ""
            Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
          Write-Host "âœ… DEV INFRASTRUCTURE BOOTSTRAP COMPLETE" -ForegroundColor Green
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
          Write-Host ""
          Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING BOOTSTRAP" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Error "Bootstrap failed with exception: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Provision Azure SQL Database
        if: success()
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘      PROVISION AZURE SQL DATABASE FOR DEV                     â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸ—„ï¸  Provisioning SQL Database for dev environment..." -ForegroundColor Cyan
            Write-Host ""
            Write-Host "ğŸ“‹ Configuration:" -ForegroundColor Yellow
            Write-Host "  Environment: dev" -ForegroundColor Gray
            Write-Host "  Resource Group: rg-orderprocessing-dev" -ForegroundColor Gray
            Write-Host "  SQL Server: orderprocessing-sql-dev" -ForegroundColor Gray
            Write-Host "  Database: OrderProcessingSystem_Dev" -ForegroundColor Gray
            Write-Host "  Location: centralindia" -ForegroundColor Gray
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
            Write-Host ""
            
            ./Resources/Azure-Deployment/provision-azure-sql.ps1 -Environment dev -BaseName orderprocessing -Location centralindia
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host ""
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ SQL PROVISIONING FAILED" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Exit Code: $LASTEXITCODE" -ForegroundColor Red
              Write-Host "Script: ./Resources/Azure-Deployment/provision-azure-sql.ps1" -ForegroundColor Gray
              Write-Host ""
              Write-Error "SQL provisioning failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
            
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "âœ… AZURE SQL DATABASE PROVISIONED SUCCESSFULLY" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING SQL PROVISIONING" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Error "SQL provisioning failed with exception: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-dev
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  bootstrap-staging:
    name: Bootstrap Staging Environment
    if: |
      always() &&
      inputs.bootstrapInfra &&
      (inputs.environment == 'staging' || inputs.environment == 'all') &&
      !cancelled() &&
      (needs.setup-oidc.result == 'success' || needs.setup-oidc.result == 'skipped') &&
      (needs.configure-secrets.result == 'success' || needs.configure-secrets.result == 'skipped') &&
      (needs.pre-validate-prerequisites.result == 'success' || needs.pre-validate-prerequisites.result == 'skipped')
    needs: [setup-oidc, configure-secrets, pre-validate-prerequisites]
    runs-on: windows-latest
    environment: staging
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate GitHub App Token
        id: app-token
        if: ${{ env.APP_ID != '' }}
        continue-on-error: true
        env:
          APP_ID: ${{ secrets.APP_ID }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      
      - name: Validate Azure Credentials
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         VALIDATE AZURE CREDENTIALS - STAGING                  â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸ” Checking Azure credentials..." -ForegroundColor Cyan
            
            $hasClientId = -not [string]::IsNullOrWhiteSpace($env:CLIENT_ID)
            $hasTenantId = -not [string]::IsNullOrWhiteSpace($env:TENANT_ID)
            $hasSubscriptionId = -not [string]::IsNullOrWhiteSpace($env:SUBSCRIPTION_ID)
            
            Write-Host "  CLIENT_ID:         $(if ($hasClientId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasClientId) { "Green" } else { "Red" })
            Write-Host "  TENANT_ID:         $(if ($hasTenantId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasTenantId) { "Green" } else { "Red" })
            Write-Host "  SUBSCRIPTION_ID:   $(if ($hasSubscriptionId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasSubscriptionId) { "Green" } else { "Red" })
            Write-Host ""
            
            if (-not $hasClientId -or -not $hasTenantId -or -not $hasSubscriptionId) {
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ AZURE CREDENTIALS MISSING" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Required credentials are not available." -ForegroundColor Red
              Write-Host ""
              Write-Host "Troubleshooting:" -ForegroundColor Yellow
              Write-Host "  1. Ensure 'Setup Azure OIDC' job completed successfully" -ForegroundColor Gray
              Write-Host "  2. OR ensure secrets are configured:" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_CLIENTID" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_TENANTID" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_SUBSCRIPTIONID" -ForegroundColor Gray
              Write-Host "  3. Re-run workflow with 'Setup Azure OIDC' = true" -ForegroundColor Gray
              Write-Host ""
              Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
              exit 1
            }
            
            Write-Host "âœ… All Azure credentials validated successfully" -ForegroundColor Green
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING CREDENTIAL VALIDATION" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Error "Credential validation failed: $($_.Exception.Message)"
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      
      - name: Verify Azure Login
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         VERIFY AZURE LOGIN - STAGING                          â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          
          try {
            Write-Host "ğŸ” Verifying Azure login..." -ForegroundColor Cyan
            $account = az account show | ConvertFrom-Json
            
            if ($LASTEXITCODE -ne 0 -or -not $account) {
              Write-Host "âŒ Azure login verification failed" -ForegroundColor Red
              Write-Error "Failed to verify Azure login"
              exit 1
            }
            
            Write-Host "âœ… Azure login verified successfully" -ForegroundColor Green
            Write-Host ""
            Write-Host "Account Details:" -ForegroundColor Yellow
            Write-Host "  Subscription: $($account.name)" -ForegroundColor Gray
            Write-Host "  Subscription ID: $($account.id)" -ForegroundColor Gray
            Write-Host "  Tenant ID: $($account.tenantId)" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host "âŒ Exception during Azure login verification: $($_.Exception.Message)" -ForegroundColor Red
            Write-Error "Failed to verify Azure login: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Bootstrap Staging Infrastructure
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         BOOTSTRAP STAGING INFRASTRUCTURE                      â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸš€ Bootstrapping Staging Environment..." -ForegroundColor Cyan
            Write-Host "" -ForegroundColor Gray
            Write-Host "ğŸ“‹ Configuration:" -ForegroundColor Yellow
            Write-Host "  Branch: staging" -ForegroundColor Gray
            Write-Host "  Environment: staging" -ForegroundColor Gray
            Write-Host "  Parameter File: infra/parameters/staging.json" -ForegroundColor Gray
            Write-Host "  Resource Group: rg-orderprocessing-staging" -ForegroundColor Gray
            Write-Host "  OIDC Subject: repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/staging" -ForegroundColor Gray
            Write-Host "" -ForegroundColor Gray
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
            Write-Host ""

            ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment staging
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host ""
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ BOOTSTRAP SCRIPT FAILED" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Exit Code: $LASTEXITCODE" -ForegroundColor Red
              Write-Host "Script: ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1" -ForegroundColor Gray
              Write-Host "Environment: staging" -ForegroundColor Gray
              Write-Host ""
              Write-Host "Check the bootstrap log artifact for detailed error information." -ForegroundColor Yellow
              Write-Host ""
              Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
            
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "âœ… STAGING INFRASTRUCTURE BOOTSTRAP COMPLETE" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING BOOTSTRAP" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Error "Bootstrap failed with exception: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Provision Azure SQL Database
        if: success()
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘      PROVISION AZURE SQL DATABASE FOR STAGING                 â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸ—„ï¸  Provisioning SQL Database for staging environment..." -ForegroundColor Cyan
            Write-Host ""
            Write-Host "ğŸ“‹ Configuration:" -ForegroundColor Yellow
            Write-Host "  Environment: staging" -ForegroundColor Gray
            Write-Host "  Resource Group: rg-orderprocessing-staging" -ForegroundColor Gray
            Write-Host "  SQL Server: orderprocessing-sql-staging" -ForegroundColor Gray
            Write-Host "  Database: OrderProcessingSystem_Staging" -ForegroundColor Gray
            Write-Host "  Location: centralindia" -ForegroundColor Gray
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
            Write-Host ""
            
            ./Resources/Azure-Deployment/provision-azure-sql.ps1 -Environment staging -BaseName orderprocessing -Location centralindia
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host ""
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ SQL PROVISIONING FAILED" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Exit Code: $LASTEXITCODE" -ForegroundColor Red
              Write-Host "Script: ./Resources/Azure-Deployment/provision-azure-sql.ps1" -ForegroundColor Gray
              Write-Host ""
              Write-Error "SQL provisioning failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
            
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "âœ… AZURE SQL DATABASE PROVISIONED SUCCESSFULLY" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING SQL PROVISIONING" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Error "SQL provisioning failed with exception: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-staging
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  bootstrap-prod:
    name: Bootstrap Production Environment
    if: |
      always() &&
      inputs.bootstrapInfra &&
      (inputs.environment == 'prod' || inputs.environment == 'all') &&
      !cancelled() &&
      (needs.setup-oidc.result == 'success' || needs.setup-oidc.result == 'skipped') &&
      (needs.configure-secrets.result == 'success' || needs.configure-secrets.result == 'skipped') &&
      (needs.pre-validate-prerequisites.result == 'success' || needs.pre-validate-prerequisites.result == 'skipped')
    needs: [setup-oidc, configure-secrets, pre-validate-prerequisites]
    runs-on: windows-latest
    environment: prod
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate GitHub App Token
        id: app-token
        if: ${{ env.APP_ID != '' }}
        continue-on-error: true
        env:
          APP_ID: ${{ secrets.APP_ID }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      
      - name: Validate Azure Credentials
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         VALIDATE AZURE CREDENTIALS - PRODUCTION              â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸ” Checking Azure credentials..." -ForegroundColor Cyan
            
            $hasClientId = -not [string]::IsNullOrWhiteSpace($env:CLIENT_ID)
            $hasTenantId = -not [string]::IsNullOrWhiteSpace($env:TENANT_ID)
            $hasSubscriptionId = -not [string]::IsNullOrWhiteSpace($env:SUBSCRIPTION_ID)
            
            Write-Host "  CLIENT_ID:         $(if ($hasClientId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasClientId) { "Green" } else { "Red" })
            Write-Host "  TENANT_ID:         $(if ($hasTenantId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasTenantId) { "Green" } else { "Red" })
            Write-Host "  SUBSCRIPTION_ID:   $(if ($hasSubscriptionId) { 'âœ… Present' } else { 'âŒ Missing' })" -ForegroundColor $(if ($hasSubscriptionId) { "Green" } else { "Red" })
            Write-Host ""
            
            if (-not $hasClientId -or -not $hasTenantId -or -not $hasSubscriptionId) {
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ AZURE CREDENTIALS MISSING" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Required credentials are not available." -ForegroundColor Red
              Write-Host ""
              Write-Host "Troubleshooting:" -ForegroundColor Yellow
              Write-Host "  1. Ensure 'Setup Azure OIDC' job completed successfully" -ForegroundColor Gray
              Write-Host "  2. OR ensure secrets are configured:" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_CLIENTID" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_TENANTID" -ForegroundColor Gray
              Write-Host "     - AZUREAPPSERVICE_SUBSCRIPTIONID" -ForegroundColor Gray
              Write-Host "  3. Re-run workflow with 'Setup Azure OIDC' = true" -ForegroundColor Gray
              Write-Host ""
              Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
              exit 1
            }
            
            Write-Host "âœ… All Azure credentials validated successfully" -ForegroundColor Green
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING CREDENTIAL VALIDATION" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Error "Credential validation failed: $($_.Exception.Message)"
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      
      - name: Verify Azure Login
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         VERIFY AZURE LOGIN - PRODUCTION                       â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          
          try {
            Write-Host "ğŸ” Verifying Azure login..." -ForegroundColor Cyan
            $account = az account show | ConvertFrom-Json
            
            if ($LASTEXITCODE -ne 0 -or -not $account) {
              Write-Host "âŒ Azure login verification failed" -ForegroundColor Red
              Write-Error "Failed to verify Azure login"
              exit 1
            }
            
            Write-Host "âœ… Azure login verified successfully" -ForegroundColor Green
            Write-Host ""
            Write-Host "Account Details:" -ForegroundColor Yellow
            Write-Host "  Subscription: $($account.name)" -ForegroundColor Gray
            Write-Host "  Subscription ID: $($account.id)" -ForegroundColor Gray
            Write-Host "  Tenant ID: $($account.tenantId)" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host "âŒ Exception during Azure login verification: $($_.Exception.Message)" -ForegroundColor Red
            Write-Error "Failed to verify Azure login: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Bootstrap Prod Infrastructure
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         BOOTSTRAP PRODUCTION INFRASTRUCTURE                   â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸš€ Bootstrapping Prod Environment..." -ForegroundColor Cyan
            Write-Host "" -ForegroundColor Gray
            Write-Host "ğŸ“‹ Configuration:" -ForegroundColor Yellow
            Write-Host "  Branch: main" -ForegroundColor Gray
            Write-Host "  Environment: prod" -ForegroundColor Gray
            Write-Host "  Parameter File: infra/parameters/prod.json" -ForegroundColor Gray
            Write-Host "  Resource Group: rg-orderprocessing-prod" -ForegroundColor Gray
            Write-Host "  OIDC Subject: repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/main" -ForegroundColor Gray
            Write-Host "" -ForegroundColor Gray
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
            Write-Host ""

            ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment prod
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host ""
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ BOOTSTRAP SCRIPT FAILED" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Exit Code: $LASTEXITCODE" -ForegroundColor Red
              Write-Host "Script: ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1" -ForegroundColor Gray
              Write-Host "Environment: prod" -ForegroundColor Gray
              Write-Host ""
              Write-Host "Check the bootstrap log artifact for detailed error information." -ForegroundColor Yellow
              Write-Host ""
              Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
            
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "âœ… PRODUCTION INFRASTRUCTURE BOOTSTRAP COMPLETE" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING BOOTSTRAP" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Error "Bootstrap failed with exception: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Provision Azure SQL Database
        if: success()
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘      PROVISION AZURE SQL DATABASE FOR PRODUCTION              â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Start Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host ""
          
          try {
            Write-Host "ğŸ—„ï¸  Provisioning SQL Database for production environment..." -ForegroundColor Cyan
            Write-Host ""
            Write-Host "ğŸ“‹ Configuration:" -ForegroundColor Yellow
            Write-Host "  Environment: prod" -ForegroundColor Gray
            Write-Host "  Resource Group: rg-orderprocessing-prod" -ForegroundColor Gray
            Write-Host "  SQL Server: orderprocessing-sql-prod" -ForegroundColor Gray
            Write-Host "  Database: OrderProcessingSystem_Prod" -ForegroundColor Gray
            Write-Host "  Location: centralindia" -ForegroundColor Gray
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
            Write-Host ""
            
            ./Resources/Azure-Deployment/provision-azure-sql.ps1 -Environment prod -BaseName orderprocessing -Location centralindia
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host ""
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host "âŒ SQL PROVISIONING FAILED" -ForegroundColor Red
              Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
              Write-Host ""
              Write-Host "Exit Code: $LASTEXITCODE" -ForegroundColor Red
              Write-Host "Script: ./Resources/Azure-Deployment/provision-azure-sql.ps1" -ForegroundColor Gray
              Write-Host ""
              Write-Error "SQL provisioning failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
            
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "âœ… AZURE SQL DATABASE PROVISIONED SUCCESSFULLY" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "End Time (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
            Write-Host ""
          }
          catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "âŒ EXCEPTION DURING SQL PROVISIONING" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Exception Message: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Stack Trace:" -ForegroundColor Yellow
            Write-Host "$($_.ScriptStackTrace)" -ForegroundColor Gray
            Write-Host ""
            Write-Error "SQL provisioning failed with exception: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-prod
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  enable-validation:
    name: Enable Pre-Deployment Validation
    if: |
      always() &&
      inputs.enableValidation &&
      inputs.bootstrapInfra &&
      !cancelled() &&
      (needs.bootstrap-dev.result == 'success' || needs.bootstrap-dev.result == 'skipped') &&
      (needs.bootstrap-staging.result == 'success' || needs.bootstrap-staging.result == 'skipped') &&
      (needs.bootstrap-prod.result == 'success' || needs.bootstrap-prod.result == 'skipped')
    needs: [bootstrap-dev, bootstrap-staging, bootstrap-prod]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Enable Validation in Workflow
        run: |
          Write-Host "ğŸ”§ Enabling pre-deployment validation..." -ForegroundColor Cyan

          $workflowPath = ".github/workflows/infra-deploy.yml"
          $content = Get-Content $workflowPath -Raw

          # Re-enable pre-validate job
          $content = $content -replace 'if: false  # TODO: Enable after bootstrap - requires Azure OIDC setup', 'if: (github.event_name == ''push'') || (github.event_name == ''workflow_dispatch'' && !inputs.dryRun)'

          # Re-enable job dependency
          $content = $content -replace '# needs: pre-validate  # TODO: Uncomment after bootstrap', 'needs: pre-validate'

          Set-Content $workflowPath -Value $content -NoNewline

          Write-Host "âœ… Validation enabled" -ForegroundColor Green

      - name: Commit Changes
        id: commit
        continue-on-error: true
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/infra-deploy.yml
          
          if (git diff --staged --quiet) {
            Write-Host "â„¹ï¸  No changes detected - validation may already be enabled" -ForegroundColor Yellow
            exit 0
          }
          
          git commit -m "chore(ci): enable pre-deployment validation after bootstrap"
          git push
      
      - name: Handle Push Failure
        if: steps.commit.outcome == 'failure'
        run: |
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Yellow
          Write-Host "â•‘    WORKFLOW UPDATE REQUIRES MANUAL ACTION                     â•‘" -ForegroundColor Yellow
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "âš ï¸  Unable to automatically update workflow file" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "GitHub's security model prevents workflows from modifying other workflow" -ForegroundColor White
          Write-Host "files using the default GITHUB_TOKEN for security reasons." -ForegroundColor White
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host "ğŸ“‹ MANUAL STEP REQUIRED (One-time, 2 minutes)" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Gray
          Write-Host ""
          Write-Host "To enable pre-deployment validation, make this change:" -ForegroundColor White
          Write-Host ""
          Write-Host "File: .github/workflows/infra-deploy.yml" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "In the pre-validate job, change:" -ForegroundColor Cyan
          Write-Host "  if: false  # TODO: Enable after bootstrap" -ForegroundColor Red
          Write-Host "to:" -ForegroundColor Cyan
          Write-Host "  if: (github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && !inputs.dryRun)" -ForegroundColor Green
          Write-Host ""
          Write-Host "Also in the deploy job, uncomment:" -ForegroundColor Cyan
          Write-Host "  needs: pre-validate" -ForegroundColor Green
          Write-Host ""
          
          Write-Warning "Automatic workflow update failed. Please manually enable validation using the instructions above."

      - name: Create Completion Summary
        run: |
          $commitSuccess = "${{ steps.commit.outcome }}" -eq "success"
          
          "## âœ… Azure Bootstrap Complete!" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ğŸ‰ What's Ready" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… Azure OIDC configured" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… GitHub secrets configured" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… Infrastructure bootstrapped (${{ inputs.environment }})" >> $env:GITHUB_STEP_SUMMARY
          
          if ($commitSuccess) {
            "- âœ… Pre-deployment validation enabled" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "- âš ï¸ Pre-deployment validation - **Manual step required** (see above)" >> $env:GITHUB_STEP_SUMMARY
          }
          
          "" >> $env:GITHUB_STEP_SUMMARY
          
          if (-not $commitSuccess) {
            "### âš ï¸ Manual Step Required" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "To enable pre-deployment validation, edit ```.github/workflows/infra-deploy.yml```:" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "1. In the ``pre-validate`` job, change ``if: false`` to ``if: (github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && !inputs.dryRun)``" >> $env:GITHUB_STEP_SUMMARY
            "2. In the ``deploy`` job, uncomment the line ``needs: pre-validate``" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "See detailed instructions in the logs above." >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
          }
          
          "### ğŸš€ Next Steps" >> $env:GITHUB_STEP_SUMMARY
          "1. Push code changes to trigger deployment workflow" >> $env:GITHUB_STEP_SUMMARY
          "2. Monitor deployments at: [Actions](https://github.com/pavanthakur/XYDataLabs.OrderProcessingSystem/actions)" >> $env:GITHUB_STEP_SUMMARY
          "3. View resources in [Azure Portal](https://portal.azure.com)" >> $env:GITHUB_STEP_SUMMARY

  summary:
    name: Bootstrap Summary
    if: always() && github.event_name == 'workflow_dispatch'
    needs: [setup-oidc, configure-secrets, pre-validate-prerequisites, bootstrap-dev, bootstrap-staging, bootstrap-prod, enable-validation]
    runs-on: windows-latest
    steps:
      - name: Generate Summary
        run: |
          "## ğŸ“Š Bootstrap Workflow Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY

          $setupOidc = "${{ needs.setup-oidc.result }}"
          $configSecrets = "${{ needs.configure-secrets.result }}"
          $preValidate = "${{ needs.pre-validate-prerequisites.result }}"
          $bootstrapDev = "${{ needs.bootstrap-dev.result }}"
          $bootstrapStaging = "${{ needs.bootstrap-staging.result }}"
          $bootstrapProd = "${{ needs.bootstrap-prod.result }}"
          $enableVal = "${{ needs.enable-validation.result }}"

          "| Step | Status |" >> $env:GITHUB_STEP_SUMMARY
          "|------|--------|" >> $env:GITHUB_STEP_SUMMARY

          if ($setupOidc -ne "") {
            $icon = if ($setupOidc -eq "success") { "âœ…" } else { "âŒ" }
            "| Setup OIDC | $icon $setupOidc |" >> $env:GITHUB_STEP_SUMMARY
          }

          if ($configSecrets -ne "") {
            $icon = if ($configSecrets -eq "success") { "âœ…" } else { "âŒ" }
            "| Configure Secrets | $icon $configSecrets |" >> $env:GITHUB_STEP_SUMMARY
          }

          if ($preValidate -ne "") {
            $icon = if ($preValidate -eq "success") { "âœ…" } elseif ($preValidate -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Pre-Validate Prerequisites | $icon $preValidate |" >> $env:GITHUB_STEP_SUMMARY
          }

          if ($bootstrapDev -ne "") {
            $icon = if ($bootstrapDev -eq "success") { "âœ…" } elseif ($bootstrapDev -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Dev | $icon $bootstrapDev |" >> $env:GITHUB_STEP_SUMMARY
          }

          if ($bootstrapStaging -ne "") {
            $icon = if ($bootstrapStaging -eq "success") { "âœ…" } elseif ($bootstrapStaging -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Staging | $icon $bootstrapStaging |" >> $env:GITHUB_STEP_SUMMARY
          }

          if ($bootstrapProd -ne "") {
            $icon = if ($bootstrapProd -eq "success") { "âœ…" } elseif ($bootstrapProd -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Prod | $icon $bootstrapProd |" >> $env:GITHUB_STEP_SUMMARY
          }

          if ($enableVal -ne "") {
            $icon = if ($enableVal -eq "success") { "âœ…" } elseif ($enableVal -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Enable Validation | $icon $enableVal |" >> $env:GITHUB_STEP_SUMMARY
          }
