name: Azure Bootstrap Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to bootstrap'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
          - all
      setupOidc:
        description: 'Setup Azure OIDC (first-time only)'
        required: true
        type: boolean
        default: false
      setupGitHubApp:
        description: 'Setup GitHub App (one-time, eliminates PAT expiration)'
        required: true
        type: boolean
        default: false
      configureSecrets:
        description: 'Configure GitHub secrets (auto if GitHub App configured)'
        required: true
        type: boolean
        default: false
      bootstrapInfra:
        description: 'Bootstrap infrastructure (App Services, etc.)'
        required: true
        type: boolean
        default: true
      enableValidation:
        description: 'Enable pre-deployment validation after bootstrap'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  check-trigger:
    name: Check Workflow Trigger
    if: github.event_name != 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - name: Workflow trigger check
        run: |
          Write-Host "â„¹ï¸  This workflow is designed for manual dispatch only" -ForegroundColor Cyan
          Write-Host "   Skipping execution for event: ${{ github.event_name }}" -ForegroundColor Yellow
          Write-Host "   To run this workflow, use: Actions > Azure Bootstrap Setup > Run workflow" -ForegroundColor Gray

  validate-inputs:
    name: Validate Workflow Inputs
    if: github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - name: Log Workflow Start
        run: |
          Write-Host "" -ForegroundColor Gray
          Write-Host "========================================================================" -ForegroundColor Cyan
          Write-Host "  AZURE BOOTSTRAP WORKFLOW STARTED" -ForegroundColor Cyan
          Write-Host "========================================================================" -ForegroundColor Cyan
          Write-Host "" -ForegroundColor Gray
          Write-Host "â° Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "ðŸ‘¤ Triggered by: ${{ github.actor }}" -ForegroundColor Gray
          Write-Host "ðŸŒ¿ Branch: ${{ github.ref_name }}" -ForegroundColor Gray
          Write-Host "ðŸ“¦ Repository: ${{ github.repository }}" -ForegroundColor Gray
          Write-Host "ðŸ”— Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray
          Write-Host "ðŸ“‹ USER SELECTED PARAMETERS:" -ForegroundColor Yellow
          Write-Host "  âœ“ Target environment:           ${{ inputs.environment }}" -ForegroundColor White
          Write-Host "  âœ“ Setup Azure OIDC:             ${{ inputs.setupOidc }}" -ForegroundColor White
          Write-Host "  âœ“ Setup GitHub App:             ${{ inputs.setupGitHubApp }}" -ForegroundColor White
          Write-Host "  âœ“ Configure GitHub secrets:     ${{ inputs.configureSecrets }}" -ForegroundColor White
          Write-Host "  âœ“ Bootstrap infrastructure:     ${{ inputs.bootstrapInfra }}" -ForegroundColor White
          Write-Host "  âœ“ Enable validation:            ${{ inputs.enableValidation }}" -ForegroundColor White
          Write-Host "" -ForegroundColor Gray
          Write-Host "========================================================================" -ForegroundColor Cyan
          Write-Host "" -ForegroundColor Gray
      
      - name: Validate Configuration
        run: |
          Write-Host "ðŸ” Validating workflow inputs..." -ForegroundColor Cyan
          Write-Host "=" * 70 -ForegroundColor Gray
          
          $env = "${{ inputs.environment }}"
          $setupOidc = "${{ inputs.setupOidc }}"
          $configSecrets = "${{ inputs.configureSecrets }}"
          $bootstrap = "${{ inputs.bootstrapInfra }}"
          $enableValidation = "${{ inputs.enableValidation }}"
          
          Write-Host "`nðŸ“‹ Workflow Inputs:" -ForegroundColor Cyan
          Write-Host "  Environment: $env" -ForegroundColor Yellow
          Write-Host "  Setup OIDC: $setupOidc" -ForegroundColor Yellow
          Write-Host "  Configure secrets: $configSecrets" -ForegroundColor Yellow
          Write-Host "  Bootstrap infra: $bootstrap" -ForegroundColor Yellow
          Write-Host "  Enable validation: $enableValidation" -ForegroundColor Yellow
          
          # Display branch-to-environment mapping
          Write-Host "`nðŸ—ºï¸  Branch â†’ Environment Mapping:" -ForegroundColor Cyan
          Write-Host "  dev branch      â†’ dev environment (dev.json)" -ForegroundColor Gray
          Write-Host "  staging branch  â†’ staging environment (staging.json)" -ForegroundColor Gray
          Write-Host "  main branch     â†’ prod environment (prod.json)" -ForegroundColor Gray
          
          # Show what will be created based on selection
          Write-Host "`nðŸ“¦ Resources to be created:" -ForegroundColor Cyan
          if ($env -eq "all") {
            Write-Host "  OIDC Credentials:" -ForegroundColor Yellow
            Write-Host "    - dev branch (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/dev)" -ForegroundColor Gray
            Write-Host "    - staging branch (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/staging)" -ForegroundColor Gray
            Write-Host "    - main branch (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/main)" -ForegroundColor Gray
            Write-Host "    - dev environment (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:dev)" -ForegroundColor Gray
            Write-Host "    - staging environment (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:staging)" -ForegroundColor Gray
            Write-Host "    - prod environment (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:prod)" -ForegroundColor Gray
            Write-Host "  GitHub Secrets: dev, staging, prod" -ForegroundColor Yellow
            Write-Host "  Bootstrap: dev, staging, prod resource groups" -ForegroundColor Yellow
          } else {
            Write-Host "  OIDC Credentials:" -ForegroundColor Yellow
            Write-Host "    - $env branch (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/$env)" -ForegroundColor Gray
            Write-Host "    - $env environment (repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:$env)" -ForegroundColor Gray
            Write-Host "  GitHub Secrets: $env" -ForegroundColor Yellow
            Write-Host "  Bootstrap: $env resource group" -ForegroundColor Yellow
          }
          
          Write-Host "`nâš ï¸  Validation Checks:" -ForegroundColor Cyan
          
          # Validate environment selection
          if ($env -notin @('dev', 'staging', 'prod', 'all')) {
            Write-Host "  âŒ Invalid environment: $env" -ForegroundColor Red
            Write-Error "Invalid environment: $env. Must be dev, staging, prod, or all."
            exit 1
          }
          Write-Host "  âœ… Environment selection valid" -ForegroundColor Green
          
          # Warn if bootstrapping without OIDC/secrets
          if ($bootstrap -eq "true" -and $setupOidc -eq "false" -and $configSecrets -eq "false") {
            Write-Host "  âš ï¸  Bootstrapping without OIDC/secrets - ensure they exist!" -ForegroundColor Yellow
          } else {
            Write-Host "  âœ… Configuration sequence valid" -ForegroundColor Green
          }
          
          Write-Host "`n" -ForegroundColor Gray
          Write-Host "=" * 70 -ForegroundColor Gray
          Write-Host "âœ… Input validation passed - proceeding..." -ForegroundColor Green

  setup-oidc:
    name: Setup Azure OIDC
    if: inputs.setupOidc
    needs: [validate-inputs]
    runs-on: windows-latest
    outputs:
      clientId: ${{ steps.oidc.outputs.clientId }}
      tenantId: ${{ steps.oidc.outputs.tenantId }}
      subscriptionId: ${{ steps.oidc.outputs.subscriptionId }}
      appObjectId: ${{ steps.oidc.outputs.appObjectId }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login (Device Code)
        timeout-minutes: 3
        run: |
          Write-Host "ðŸ” Azure Login Required" -ForegroundColor Cyan
          Write-Host "This is a one-time setup. Please authenticate when prompted." -ForegroundColor Yellow
          Write-Host "â±ï¸  Timeout: 3 minutes" -ForegroundColor Yellow
          az login --use-device-code
      
      - name: Setup OIDC App Registration
        id: oidc
        run: |
          Write-Host "ðŸš€ Setting up GitHub Actions OIDC..." -ForegroundColor Cyan
          
          # Determine branches and environments based on input
          $selectedEnv = "${{ inputs.environment }}"
          if ($selectedEnv -eq "all") {
            $branches = "dev,staging,main"
            $environments = "dev,staging,prod"
          } else {
            $branches = $selectedEnv
            $environments = $selectedEnv
          }
          
          Write-Host "Creating credentials for:" -ForegroundColor Yellow
          Write-Host "  Branches: $branches" -ForegroundColor Gray
          Write-Host "  Environments: $environments" -ForegroundColor Gray
          Write-Host "  Repository: pavanthakur/XYDataLabs.OrderProcessingSystem" -ForegroundColor Gray
          
          # Run setup script
          ./Resources/Azure-Deployment/setup-github-oidc.ps1 `
            -Branches $branches `
            -Environments $environments `
            -GitHubOwner "pavanthakur" `
            -Repository "XYDataLabs.OrderProcessingSystem"
          
          Write-Host "" -ForegroundColor Gray
          Write-Host "Script parameters passed:" -ForegroundColor Cyan
          Write-Host "  -Branches $branches" -ForegroundColor Gray
          Write-Host "  -Environments $environments" -ForegroundColor Gray
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "OIDC setup failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          # Extract credentials from Azure
          $sub = az account show | ConvertFrom-Json
          if (-not $sub) {
            Write-Error "Failed to get Azure subscription"
            exit 1
          }
          
          $app = az ad app list --display-name "GitHub-Actions-OIDC" | ConvertFrom-Json
          if (-not $app -or $app.Count -eq 0) {
            Write-Error "Failed to create or find OIDC app"
            exit 1
          }
          
          $clientId = $app[0].appId
          $appObjectId = $app[0].id
          $tenantId = $sub.tenantId
          $subscriptionId = $sub.id
          
          # Output for next jobs
          "clientId=$clientId" >> $env:GITHUB_OUTPUT
          "tenantId=$tenantId" >> $env:GITHUB_OUTPUT
          "subscriptionId=$subscriptionId" >> $env:GITHUB_OUTPUT
          "appObjectId=$appObjectId" >> $env:GITHUB_OUTPUT
          
          Write-Host "âœ… OIDC Setup Complete" -ForegroundColor Green
          Write-Host "   Client ID: $clientId" -ForegroundColor Gray
          Write-Host "   Tenant ID: $tenantId" -ForegroundColor Gray
          Write-Host "   App Object ID: $appObjectId" -ForegroundColor Gray
      
      - name: Verify Federated Credentials
        run: |
          Write-Host "ðŸ” Verifying federated credentials..." -ForegroundColor Cyan
          
          $appObjectId = "${{ steps.oidc.outputs.appObjectId }}"
          $expectedPattern = "repo:pavanthakur/XYDataLabs.OrderProcessingSystem"
          $selectedEnv = "${{ inputs.environment }}"
          $expectedCount = if ($selectedEnv -eq "all") { 6 } else { 2 }
          $maxRetries = 3
          $retryDelay = 20
          $validCreds = $null
          
          Write-Host "Expected credentials count: $expectedCount (environment: $selectedEnv)" -ForegroundColor Gray
          
          for ($i = 1; $i -le $maxRetries; $i++) {
            Write-Host "`n[Attempt $i/$maxRetries] Waiting $retryDelay seconds for Azure AD propagation..." -ForegroundColor Gray
            Start-Sleep -Seconds $retryDelay
            
            Write-Host "Purging Azure CLI cache and querying credentials..." -ForegroundColor Gray
            az cache purge 2>$null | Out-Null
            $creds = az ad app federated-credential list --id $appObjectId | ConvertFrom-Json
            
            $validCount = ($creds | Where-Object { $_.subject -like "$expectedPattern*" }).Count
            Write-Host "Found $validCount/$($creds.Count) credentials with correct format" -ForegroundColor $(if ($validCount -eq $expectedCount) { "Green" } else { "Yellow" })
            
            if ($validCount -eq $expectedCount) {
              Write-Host "âœ… All credentials have propagated correctly!" -ForegroundColor Green
              $validCreds = $creds
              break
            }
            
            if ($i -lt $maxRetries) {
              Write-Host "âš ï¸ Still seeing old credentials, retrying..." -ForegroundColor Yellow
            }
          }
          
          if (-not $validCreds) {
            Write-Warning "Azure AD still showing stale credentials after $($maxRetries * $retryDelay) seconds"
            Write-Warning "This is likely an Azure AD caching issue. Proceeding with manual verification..."
            $creds = az ad app federated-credential list --id $appObjectId | ConvertFrom-Json
          } else {
            $creds = $validCreds
          }
          
          Write-Host "`nCreated federated credentials:" -ForegroundColor Green
          foreach ($cred in $creds) {
            Write-Host "  - Name: $($cred.name)" -ForegroundColor White
            Write-Host "    Subject: $($cred.subject)" -ForegroundColor Gray
          }
          
          if ($creds.Count -lt $expectedCount) {
            Write-Warning "Expected $expectedCount federated credentials, found $($creds.Count). OIDC setup may be incomplete."
            Write-Warning "Re-run this workflow with 'Setup OIDC' enabled to create missing credentials."
          } else {
            Write-Host "`nâœ… All $expectedCount federated credentials verified!" -ForegroundColor Green
          }
          
          Write-Host "`nðŸ”Ž Checking for required credentials..." -ForegroundColor Cyan
          
          # Check branch credential for selected environment
          Write-Host "Searching for $selectedEnv branch credential..." -ForegroundColor Gray
          $expectedBranch = "repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/$selectedEnv"
          Write-Host "Expected: $expectedBranch" -ForegroundColor Gray
          $devBranchCred = $creds | Where-Object { $_.subject -eq $expectedBranch }
          if ($devBranchCred) {
            Write-Host "âœ… $selectedEnv branch credential found: $($devBranchCred.name)" -ForegroundColor Green
          } else {
            Write-Host "âŒ $selectedEnv branch credential NOT found" -ForegroundColor Red
            Write-Host "Actual subjects found:" -ForegroundColor Yellow
            foreach ($cred in $creds) {
              Write-Host "  - $($cred.subject)" -ForegroundColor Yellow
            }
            Write-Error "âš ï¸ $selectedEnv branch federated credential is missing! Bootstrap will fail."
          }
          
          # Check environment credential for selected environment
          Write-Host "`nSearching for $selectedEnv environment credential..." -ForegroundColor Gray
          $expectedEnv = "repo:pavanthakur/XYDataLabs.OrderProcessingSystem:environment:$selectedEnv"
          Write-Host "Expected: $expectedEnv" -ForegroundColor Gray
          $devEnvCred = $creds | Where-Object { $_.subject -eq $expectedEnv }
          if ($devEnvCred) {
            Write-Host "âœ… $selectedEnv environment credential found: $($devEnvCred.name)" -ForegroundColor Green
          } else {
            Write-Host "âŒ $selectedEnv environment credential NOT found" -ForegroundColor Red
          }
      
      - name: Create Setup Summary
        run: |
          "## ðŸ” Azure OIDC Setup Complete" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸ“‹ Azure Credentials" >> $env:GITHUB_STEP_SUMMARY
          "- **Client ID**: ``${{ steps.oidc.outputs.clientId }}``" >> $env:GITHUB_STEP_SUMMARY
          "- **Tenant ID**: ``${{ steps.oidc.outputs.tenantId }}``" >> $env:GITHUB_STEP_SUMMARY
          "- **Subscription ID**: ``${{ steps.oidc.outputs.subscriptionId }}``" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸ”‘ Next Steps - Choose One Option" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "#### Option 1: GitHub App â­ RECOMMENDED - Zero Maintenance" >> $env:GITHUB_STEP_SUMMARY
          "**Benefits**: âœ… Never expires â€¢ âœ… Auto-generated tokens â€¢ âœ… Better security" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "1. Create GitHub App: [Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md](../blob/main/Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md)" >> $env:GITHUB_STEP_SUMMARY
          "2. Add these secrets:" >> $env:GITHUB_STEP_SUMMARY
          "   - ``GH_APP_ID`` - Your GitHub App ID" >> $env:GITHUB_STEP_SUMMARY
          "   - ``GH_APP_INSTALLATION_ID`` - Installation ID" >> $env:GITHUB_STEP_SUMMARY
          "   - ``GH_APP_PRIVATE_KEY`` - Private key (PEM format)" >> $env:GITHUB_STEP_SUMMARY
          "3. Re-run this workflow with ``Configure GitHub secrets`` enabled" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "#### Option 2: Personal Access Token (Requires Renewal)" >> $env:GITHUB_STEP_SUMMARY
          "**Drawback**: âš ï¸ Expires (max 1 year) â€¢ âš ï¸ Manual renewal required" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "1. Create fine-grained PAT: https://github.com/settings/tokens?type=beta" >> $env:GITHUB_STEP_SUMMARY
          "   - Grant **Secrets** permission (read/write)" >> $env:GITHUB_STEP_SUMMARY
          "   - Set expiration (max 1 year)" >> $env:GITHUB_STEP_SUMMARY
          "2. Add PAT as repository secret:" >> $env:GITHUB_STEP_SUMMARY
          "   - Go to: https://github.com/${{ github.repository }}/settings/secrets/actions/new" >> $env:GITHUB_STEP_SUMMARY
          "   - Name: ``GH_PAT``" >> $env:GITHUB_STEP_SUMMARY
          "   - Value: Your PAT token" >> $env:GITHUB_STEP_SUMMARY
          "3. **Set calendar reminder** to renew before expiration" >> $env:GITHUB_STEP_SUMMARY
          "4. Re-run this workflow with ``Configure GitHub secrets`` enabled" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "#### Option 3: Manual Configuration (No Automation)" >> $env:GITHUB_STEP_SUMMARY
          "Add these secrets manually at: https://github.com/${{ github.repository }}/settings/secrets/actions" >> $env:GITHUB_STEP_SUMMARY
          "- ``AZUREAPPSERVICE_CLIENTID``: ``${{ steps.oidc.outputs.clientId }}``" >> $env:GITHUB_STEP_SUMMARY
          "- ``AZUREAPPSERVICE_TENANTID``: ``${{ steps.oidc.outputs.tenantId }}``" >> $env:GITHUB_STEP_SUMMARY
          "- ``AZUREAPPSERVICE_SUBSCRIPTIONID``: ``${{ steps.oidc.outputs.subscriptionId }}``" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸ“¦ After Secrets Are Configured" >> $env:GITHUB_STEP_SUMMARY
          "Run this workflow again with ``Bootstrap infrastructure`` enabled" >> $env:GITHUB_STEP_SUMMARY

  setup-github-app:
    name: Setup GitHub App
    if: inputs.setupGitHubApp
    needs: [validate-inputs]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Explain GitHub App Setup
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "GitHub App Setup - One-Time Configuration" -ForegroundColor White
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ðŸŽ¯ Goal: Eliminate PAT token expiration forever" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "Benefits:" -ForegroundColor Cyan
          Write-Host "  âœ… Tokens auto-generated (never expire)" -ForegroundColor Green
          Write-Host "  âœ… No manual renewal needed" -ForegroundColor Green
          Write-Host "  âœ… Better security (short-lived tokens)" -ForegroundColor Green
          Write-Host "  âœ… Full automation after initial setup" -ForegroundColor Green
          Write-Host ""
          Write-Host "âš ï¸  GitHub Security Requirement:" -ForegroundColor Yellow
          Write-Host "   For security, GitHub requires interactive authorization" -ForegroundColor Gray
          Write-Host "   for first-time app creation. This is by design." -ForegroundColor Gray
          Write-Host ""
          Write-Host "â±ï¸  One-time manual setup required (5 minutes)" -ForegroundColor Cyan
          Write-Host "   After this, everything is fully automated!" -ForegroundColor Green
          Write-Host ""
      
      - name: Check Existing GitHub App
        id: check-app
        run: |
          Write-Host "ðŸ” Checking for existing GitHub App configuration..." -ForegroundColor Cyan
          
          $hasAppId = "${{ secrets.GH_APP_ID }}" -ne ""
          $hasInstallationId = "${{ secrets.GH_APP_INSTALLATION_ID }}" -ne ""
          $hasPrivateKey = "${{ secrets.GH_APP_PRIVATE_KEY }}" -ne ""
          
          if ($hasAppId -and $hasInstallationId -and $hasPrivateKey) {
            Write-Host "  âœ… GitHub App already configured!" -ForegroundColor Green
            Write-Host "     App ID: Present" -ForegroundColor Gray
            Write-Host "     Installation ID: Present" -ForegroundColor Gray
            Write-Host "     Private Key: Present" -ForegroundColor Gray
            Write-Host ""
            Write-Host "  No setup needed. Workflow will use existing app." -ForegroundColor Green
            "alreadyConfigured=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "  â„¹ï¸  GitHub App not configured" -ForegroundColor Yellow
            Write-Host "     Missing: " -NoNewline -ForegroundColor Gray
            if (-not $hasAppId) { Write-Host "GH_APP_ID " -NoNewline -ForegroundColor Yellow }
            if (-not $hasInstallationId) { Write-Host "GH_APP_INSTALLATION_ID " -NoNewline -ForegroundColor Yellow }
            if (-not $hasPrivateKey) { Write-Host "GH_APP_PRIVATE_KEY" -ForegroundColor Yellow }
            Write-Host ""
            "alreadyConfigured=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Provide Setup Instructions
        if: steps.check-app.outputs.alreadyConfigured != 'true'
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "ðŸ“‹ SETUP INSTRUCTIONS" -ForegroundColor White
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "â±ï¸  Estimated time: 5 minutes" -ForegroundColor Gray
          Write-Host ""
          Write-Host "Step 1: Create GitHub App (2 minutes)" -ForegroundColor Cyan
          Write-Host "  ðŸ”— https://github.com/settings/apps/new" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "  Fill in:" -ForegroundColor White
          Write-Host "    Name: OrderProcessingSystem-SecretManager" -ForegroundColor Gray
          Write-Host "    Homepage: https://github.com/${{ github.repository }}" -ForegroundColor Gray
          Write-Host "    Webhook: UNCHECK 'Active'" -ForegroundColor Gray
          Write-Host ""
          Write-Host "  Permissions â†’ Repository permissions:" -ForegroundColor White
          Write-Host "    Secrets: Read and write âœ…" -ForegroundColor Gray
          Write-Host ""
          Write-Host "  Click 'Create GitHub App'" -ForegroundColor White
          Write-Host ""
          Write-Host "Step 2: Generate Private Key (30 seconds)" -ForegroundColor Cyan
          Write-Host "  After creation, scroll to 'Private keys' section" -ForegroundColor White
          Write-Host "  Click 'Generate a private key'" -ForegroundColor White
          Write-Host "  Save the downloaded .pem file" -ForegroundColor White
          Write-Host ""
          Write-Host "Step 3: Install App (30 seconds)" -ForegroundColor Cyan
          Write-Host "  Click 'Install App' in left sidebar" -ForegroundColor White
          Write-Host "  Select your account" -ForegroundColor White
          Write-Host "  Choose 'Only select repositories'" -ForegroundColor White
          Write-Host "  Select: ${{ github.repository }}" -ForegroundColor White
          Write-Host "  Click 'Install'" -ForegroundColor White
          Write-Host ""
          Write-Host "  ðŸ“ Copy Installation ID from URL:" -ForegroundColor White
          Write-Host "     Format: https://github.com/settings/installations/12345678" -ForegroundColor Gray
          Write-Host "     Installation ID = 12345678" -ForegroundColor Gray
          Write-Host ""
          Write-Host "Step 4: Add Repository Secrets (1 minute)" -ForegroundColor Cyan
          Write-Host "  ðŸ”— https://github.com/${{ github.repository }}/settings/secrets/actions" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "  Add these 3 secrets:" -ForegroundColor White
          Write-Host ""
          Write-Host "    1. GH_APP_ID" -ForegroundColor Cyan
          Write-Host "       Value: [App ID from app settings page]" -ForegroundColor Gray
          Write-Host ""
          Write-Host "    2. GH_APP_INSTALLATION_ID" -ForegroundColor Cyan
          Write-Host "       Value: [Installation ID from URL above]" -ForegroundColor Gray
          Write-Host ""
          Write-Host "    3. GH_APP_PRIVATE_KEY" -ForegroundColor Cyan
          Write-Host "       Value: [Full contents of .pem file]" -ForegroundColor Gray
          Write-Host "       Note: Copy entire file including BEGIN/END lines" -ForegroundColor DarkGray
          Write-Host ""
          Write-Host "Step 5: Re-run This Workflow" -ForegroundColor Cyan
          Write-Host "  After adding secrets, run this workflow again" -ForegroundColor White
          Write-Host "  Enable: 'Configure GitHub secrets' = true" -ForegroundColor White
          Write-Host "  The workflow will automatically use GitHub App" -ForegroundColor White
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "âœ¨ After this one-time setup:" -ForegroundColor White
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "  âœ… Tokens auto-generate on every run" -ForegroundColor Green
          Write-Host "  âœ… No expiration to track" -ForegroundColor Green
          Write-Host "  âœ… No maintenance needed" -ForegroundColor Green
          Write-Host "  âœ… Fully automated forever!" -ForegroundColor Green
          Write-Host ""
          Write-Host "ðŸ“– Detailed guide:" -ForegroundColor Cyan
          Write-Host "   Documentation/03-Configuration-Guides/QUICK-SETUP-GITHUB-APP.md" -ForegroundColor White
          Write-Host ""
      
      - name: Create Setup Summary
        run: |
          "## ðŸ” GitHub App Setup" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          
          $hasApp = "${{ steps.check-app.outputs.alreadyConfigured }}" -eq "true"
          
          if ($hasApp) {
            "### âœ… Already Configured" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "GitHub App is already set up and ready to use." >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "**Configuration detected**:" >> $env:GITHUB_STEP_SUMMARY
            "- ``GH_APP_ID`` âœ…" >> $env:GITHUB_STEP_SUMMARY
            "- ``GH_APP_INSTALLATION_ID`` âœ…" >> $env:GITHUB_STEP_SUMMARY
            "- ``GH_APP_PRIVATE_KEY`` âœ…" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "**Next step**: Re-run workflow with ``Configure GitHub secrets`` enabled" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "### â±ï¸ One-Time Manual Setup Required (5 minutes)" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "GitHub's security model requires interactive authorization for app creation." >> $env:GITHUB_STEP_SUMMARY
            "This is a one-time setup that takes about 5 minutes." >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "### ðŸ“‹ Quick Setup Steps" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "1. **Create App** (2 min): https://github.com/settings/apps/new" >> $env:GITHUB_STEP_SUMMARY
            "   - Name: ``OrderProcessingSystem-SecretManager``" >> $env:GITHUB_STEP_SUMMARY
            "   - Permissions â†’ Secrets: Read and write" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "2. **Generate Key** (30 sec): Click 'Generate a private key', save .pem file" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "3. **Install App** (30 sec): Install on repository ${{ github.repository }}" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "4. **Add Secrets** (1 min): https://github.com/${{ github.repository }}/settings/secrets/actions" >> $env:GITHUB_STEP_SUMMARY
            "   - ``GH_APP_ID``" >> $env:GITHUB_STEP_SUMMARY
            "   - ``GH_APP_INSTALLATION_ID``" >> $env:GITHUB_STEP_SUMMARY
            "   - ``GH_APP_PRIVATE_KEY``" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "5. **Re-run Workflow**: Enable 'Configure GitHub secrets'" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "### ðŸ“– Detailed Guide" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "[Quick Setup Guide](../blob/main/Documentation/03-Configuration-Guides/QUICK-SETUP-GITHUB-APP.md)" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "### âœ¨ After Setup" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… Tokens auto-generate forever" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… No expiration" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… No maintenance" >> $env:GITHUB_STEP_SUMMARY
            "- âœ… Fully automated" >> $env:GITHUB_STEP_SUMMARY
          }

  configure-secrets:
    name: Configure GitHub Secrets
    if: inputs.configureSecrets
    needs: [validate-inputs, setup-oidc, setup-github-app]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Prerequisites
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "ðŸ” Checking if OIDC setup was performed..." -ForegroundColor Cyan
          $setupOidc = "${{ inputs.setupOidc }}"
          $hasClientId = "${{ needs.setup-oidc.outputs.clientId }}" -ne ""
          
          if ($setupOidc -eq "true" -and -not $hasClientId) {
            Write-Error "OIDC setup was enabled but no client ID was output. Check setup-oidc job logs."
            exit 1
          }
          
          if ($setupOidc -eq "false" -and -not $hasClientId) {
            Write-Warning "Running without OIDC setup. Ensure Azure app credentials already exist in secrets."
          }
          
          Write-Host "" -ForegroundColor Gray
          Write-Host "âœ… All prerequisites validated" -ForegroundColor Green
      
      - name: Generate GitHub App Token
        id: app-token
        if: secrets.GH_APP_ID != '' && secrets.GH_APP_PRIVATE_KEY != '' && secrets.GH_APP_INSTALLATION_ID != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      
      - name: Check Required Secrets
        id: check
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          GH_APP_ID: ${{ secrets.GH_APP_ID }}
        run: |
          $hasClientId = "${{ secrets.AZUREAPPSERVICE_CLIENTID }}" -ne ""
          $hasTenantId = "${{ secrets.AZUREAPPSERVICE_TENANTID }}" -ne ""
          $hasSubscriptionId = "${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}" -ne ""

          Write-Host "---- BEGIN REPOSITORY SECRET BASELINE ----" -ForegroundColor Cyan
          Write-Host "Repo Secret Present?  AZUREAPPSERVICE_CLIENTID    : $hasClientId" -ForegroundColor Gray
          Write-Host "Repo Secret Present?  AZUREAPPSERVICE_TENANTID    : $hasTenantId" -ForegroundColor Gray
          Write-Host "Repo Secret Present?  AZUREAPPSERVICE_SUBSCRIPTIONID : $hasSubscriptionId" -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray
          
          # Check authentication method (prefer GitHub App over PAT)
          if ($env:GH_APP_TOKEN) {
            Write-Host "Authentication method: GitHub App (App ID: $env:GH_APP_ID)" -ForegroundColor Green
            Write-Host "  âœ… Auto-generated token (expires in 1 hour, auto-renewed)" -ForegroundColor Green
            Write-Host "  âœ… No token expiration maintenance required!" -ForegroundColor Green
            "useGitHubApp=true" >> $env:GITHUB_OUTPUT
          } elseif ($env:GH_PAT) {
            Write-Host "Authentication method: PAT (Personal Access Token)" -ForegroundColor Yellow
            Write-Host "  âš ï¸  Requires manual renewal on expiration" -ForegroundColor Yellow
            Write-Host "  ðŸ’¡ Consider migrating to GitHub App for zero maintenance" -ForegroundColor Cyan
            "useGitHubApp=false" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Authentication method: None" -ForegroundColor Red
            Write-Host "  âŒ Cannot set secrets automatically" -ForegroundColor Red
            Write-Host "  ðŸ“– See Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md" -ForegroundColor Yellow
            "useGitHubApp=false" >> $env:GITHUB_OUTPUT
          }
          
          Write-Host "" -ForegroundColor Gray
          Write-Host "Timestamp (UTC): $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "---- END REPOSITORY SECRET BASELINE ----" -ForegroundColor Cyan
          
          if ($hasClientId -and $hasTenantId -and $hasSubscriptionId) {
            Write-Host "âœ… All secrets already configured" -ForegroundColor Green
            "secretsExist=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âš ï¸ Secrets missing, will attempt configuration" -ForegroundColor Yellow
            "secretsExist=false" >> $env:GITHUB_OUTPUT
          }

      - name: Log Token Availability
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          Write-Host "ðŸ”‘ Authentication Status:" -ForegroundColor Cyan
          
          if ($env:GH_APP_TOKEN) {
            Write-Host "  âœ… GitHub App configured - automatic token generation" -ForegroundColor Green
            Write-Host "     No expiration maintenance required!" -ForegroundColor Green
          } elseif ($env:GH_PAT) {
            Write-Host "  âœ… PAT configured - can set secrets" -ForegroundColor Yellow
            Write-Host "     âš ï¸  Remember to renew PAT before expiration" -ForegroundColor Yellow
            Write-Host "     ðŸ’¡ Migrate to GitHub App: Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md" -ForegroundColor Cyan
          } else {
            Write-Host "  âŒ No authentication configured" -ForegroundColor Red
            Write-Host "     Repository secrets must be set manually" -ForegroundColor Red
            Write-Host "" -ForegroundColor Gray
            Write-Host "  Choose one option:" -ForegroundColor Yellow
            Write-Host "    1. GitHub App (recommended) - zero maintenance" -ForegroundColor Cyan
            Write-Host "       See: Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md" -ForegroundColor Gray
            Write-Host "    2. PAT (requires renewal) - add GH_PAT secret" -ForegroundColor Cyan
            Write-Host "       See: Documentation/GITHUB-SECRETS-FIX.md" -ForegroundColor Gray
            Write-Host "    3. Manual setup - set secrets manually" -ForegroundColor Cyan
          }
      
      - name: Set Repository Secrets
        if: steps.check.outputs.secretsExist == 'false'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId }}
          TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId }}
          SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId }}
        run: |
          Write-Host "---- BEGIN REPOSITORY SECRET CONFIGURATION ----" -ForegroundColor Cyan
          Write-Host "UTC Start: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          
          # Determine authentication method (prefer GitHub App)
          $token = $null
          $authMethod = "None"
          
          if ($env:GH_APP_TOKEN) {
            $token = $env:GH_APP_TOKEN
            $authMethod = "GitHub App"
            Write-Host "Using GitHub App authentication (auto-generated token)" -ForegroundColor Green
            Write-Host "  âœ… Token expires in 1 hour (auto-renewed on next run)" -ForegroundColor Green
            Write-Host "  âœ… No maintenance required!" -ForegroundColor Green
          } elseif ($env:GH_PAT) {
            $token = $env:GH_PAT
            $authMethod = "PAT"
            Write-Host "Using PAT authentication (manual token)" -ForegroundColor Yellow
            Write-Host "  âš ï¸  Remember to renew before expiration" -ForegroundColor Yellow
          }
          
          if (-not $token) {
            Write-Host "âš ï¸  No authentication token available - cannot set repository secrets" -ForegroundColor Yellow
            Write-Host "    GITHUB_TOKEN does not have permission to create/update repository secrets" -ForegroundColor Yellow
            Write-Host "" -ForegroundColor Gray
            Write-Host "ðŸ“‹ REQUIRED ACTION: Choose one option" -ForegroundColor Yellow
            Write-Host "" -ForegroundColor Gray
            Write-Host "Option 1: GitHub App (Recommended - Zero Maintenance)" -ForegroundColor Cyan
            Write-Host "  Benefits:" -ForegroundColor Green
            Write-Host "    âœ… Tokens auto-generated (never expire)" -ForegroundColor Green
            Write-Host "    âœ… No manual renewal needed" -ForegroundColor Green
            Write-Host "    âœ… Better security (short-lived tokens)" -ForegroundColor Green
            Write-Host "  Setup:" -ForegroundColor White
            Write-Host "    1. See: Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md" -ForegroundColor Gray
            Write-Host "    2. Create GitHub App and add these secrets:" -ForegroundColor Gray
            Write-Host "       - GH_APP_ID" -ForegroundColor Gray
            Write-Host "       - GH_APP_INSTALLATION_ID" -ForegroundColor Gray
            Write-Host "       - GH_APP_PRIVATE_KEY" -ForegroundColor Gray
            Write-Host "" -ForegroundColor Gray
            Write-Host "Option 2: PAT (Requires Manual Renewal)" -ForegroundColor Cyan
            Write-Host "  Setup:" -ForegroundColor White
            Write-Host "    1. Create PAT: https://github.com/settings/tokens?type=beta" -ForegroundColor Gray
            Write-Host "    2. Grant 'Secrets' permission (read/write)" -ForegroundColor Gray
            Write-Host "    3. Set expiration (max 1 year)" -ForegroundColor Gray
            Write-Host "    4. Add as GH_PAT secret" -ForegroundColor Gray
            Write-Host "" -ForegroundColor Gray
            Write-Host "Option 3: Manual Configuration (No Automation)" -ForegroundColor Cyan
            Write-Host "  Go to: https://github.com/${{ github.repository }}/settings/secrets/actions" -ForegroundColor Gray
            Write-Host "  Add these secrets:" -ForegroundColor White
            Write-Host "    - AZUREAPPSERVICE_CLIENTID = $env:CLIENT_ID" -ForegroundColor Gray
            Write-Host "    - AZUREAPPSERVICE_TENANTID = $env:TENANT_ID" -ForegroundColor Gray
            Write-Host "    - AZUREAPPSERVICE_SUBSCRIPTIONID = $env:SUBSCRIPTION_ID" -ForegroundColor Gray
            Write-Host "" -ForegroundColor Gray
            Write-Host "---- END REPOSITORY SECRET CONFIGURATION ----" -ForegroundColor Cyan
            exit 0
          }
          
          # Set GH_TOKEN for gh CLI
          $env:GH_TOKEN = $token
          
          Write-Host "ðŸ”‘ Setting GitHub repository secrets..." -ForegroundColor Cyan
          
          Write-Host "  Setting AZUREAPPSERVICE_CLIENTID..." -ForegroundColor Gray
          gh secret set AZUREAPPSERVICE_CLIENTID --repo ${{ github.repository }} --body "$env:CLIENT_ID"
          if ($LASTEXITCODE -ne 0) { Write-Error "Failed to set AZUREAPPSERVICE_CLIENTID"; exit 1 }
          
          Write-Host "  Setting AZUREAPPSERVICE_TENANTID..." -ForegroundColor Gray
          gh secret set AZUREAPPSERVICE_TENANTID --repo ${{ github.repository }} --body "$env:TENANT_ID"
          if ($LASTEXITCODE -ne 0) { Write-Error "Failed to set AZUREAPPSERVICE_TENANTID"; exit 1 }
          
          Write-Host "  Setting AZUREAPPSERVICE_SUBSCRIPTIONID..." -ForegroundColor Gray
          gh secret set AZUREAPPSERVICE_SUBSCRIPTIONID --repo ${{ github.repository }} --body "$env:SUBSCRIPTION_ID"
          if ($LASTEXITCODE -ne 0) { Write-Error "Failed to set AZUREAPPSERVICE_SUBSCRIPTIONID"; exit 1 }
          
          Write-Host "  âœ… Repository secrets configured successfully using $authMethod!" -ForegroundColor Green

          Write-Host "UTC End: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "---- END REPOSITORY SECRET CONFIGURATION ----" -ForegroundColor Cyan

      - name: Set Environment Secrets
        if: steps.check.outputs.secretsExist == 'false'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId }}
          TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId }}
          SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId }}
        run: |
          $selectedEnv = "${{ inputs.environment }}"
          
          Write-Host "---- BEGIN ENVIRONMENT SECRET CONFIGURATION ----" -ForegroundColor Cyan
          Write-Host "UTC Start: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "Target selection: $selectedEnv" -ForegroundColor Gray
          
          # Determine authentication method (prefer GitHub App)
          $token = $null
          $authMethod = "None"
          
          if ($env:GH_APP_TOKEN) {
            $token = $env:GH_APP_TOKEN
            $authMethod = "GitHub App"
            Write-Host "Using GitHub App authentication" -ForegroundColor Green
          } elseif ($env:GH_PAT) {
            $token = $env:GH_PAT
            $authMethod = "PAT"
            Write-Host "Using PAT authentication" -ForegroundColor Yellow
          }
          
          # Check if authentication is available
          if (-not $token) {
            Write-Host "âš ï¸  No authentication configured - skipping environment secrets" -ForegroundColor Yellow
            Write-Host "    Environment secrets require GitHub App or PAT" -ForegroundColor Yellow
            Write-Host "    See: Documentation/03-Configuration-Guides/GITHUB-APP-AUTHENTICATION.md" -ForegroundColor Yellow
            Write-Host "---- END ENVIRONMENT SECRET CONFIGURATION ----" -ForegroundColor Cyan
            exit 0
          }
          
          # Set GH_TOKEN for gh CLI commands
          $env:GH_TOKEN = $token
          
          # Determine which environments to configure
          $environments = @()
          if ($selectedEnv -eq "all") {
            $environments = @("dev", "staging", "prod")
          } else {
            $environments = @($selectedEnv)
          }
          
          Write-Host "ðŸ”‘ Setting GitHub environment secrets for '$selectedEnv'..." -ForegroundColor Cyan
          
          foreach ($env_name in $environments) {
            Write-Host "`n  Configuring environment: $env_name" -ForegroundColor Yellow
            
            # Check if environment secret already exists (list existing secrets)
            Write-Host "  Checking existing environment secret set BEFORE changes..." -ForegroundColor Gray
            $ownerRepo = "${{ github.repository }}"
            $owner, $repo = $ownerRepo -split '/', 2
            
            try {
              $existingSecrets = gh api -H "Accept: application/vnd.github+json" repos/$owner/$repo/environments/$env_name/secrets 2>$null | ConvertFrom-Json
              if ($existingSecrets -and $existingSecrets.secrets) {
                Write-Host "    Existing secrets: $($existingSecrets.secrets.Count)" -ForegroundColor Gray
              } else {
                Write-Host "    (Could not list pre-existing secrets or none present)" -ForegroundColor Gray
              }
            } catch {
              Write-Host "    (Could not list pre-existing secrets or none present)" -ForegroundColor Gray
            }
            
            # Set environment secrets
            $secretsToSet = @{
              "AZUREAPPSERVICE_CLIENTID" = $env:CLIENT_ID
              "AZUREAPPSERVICE_TENANTID" = $env:TENANT_ID
              "AZUREAPPSERVICE_SUBSCRIPTIONID" = $env:SUBSCRIPTION_ID
            }
            
            foreach ($secretName in $secretsToSet.Keys) {
              Write-Host "  Setting $secretName..." -ForegroundColor Gray
              gh secret set $secretName --env $env_name --repo $ownerRepo --body $secretsToSet[$secretName] 2>&1 | Out-Null
              if ($LASTEXITCODE -ne 0) {
                Write-Error "Failed to set $secretName for $env_name"
                exit 1
              }
              Write-Host "    âœ… $secretName set for $env_name" -ForegroundColor Green
            }
          }
          
          Write-Host "`n  âœ… Environment secrets configured successfully!" -ForegroundColor Green
          Write-Host "UTC End: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "---- END ENVIRONMENT SECRET CONFIGURATION ----" -ForegroundColor Cyan

      - name: Verify Repository Secrets
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          Write-Host "---- BEGIN REPOSITORY SECRET VERIFICATION ----" -ForegroundColor Cyan
          Write-Host "UTC Start: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          
          # Use GitHub App token, PAT, or GITHUB_TOKEN (in order of preference)
          if ($env:GH_APP_TOKEN) {
            $env:GH_TOKEN = $env:GH_APP_TOKEN
            Write-Host "Using GitHub App token for verification" -ForegroundColor Green
          } elseif ($env:GH_PAT) {
            $env:GH_TOKEN = $env:GH_PAT
            Write-Host "Using PAT for verification" -ForegroundColor Yellow
          } else {
            $env:GH_TOKEN = "${{ secrets.GITHUB_TOKEN }}"
            Write-Host "Using GITHUB_TOKEN for verification (read-only)" -ForegroundColor Yellow
          }

          Write-Host "ðŸ”Ž Verifying repository secrets..." -ForegroundColor Cyan
          
          $ownerRepo = "${{ github.repository }}"
          $owner, $repo = $ownerRepo -split '/', 2

          $respJson = gh api -H "Accept: application/vnd.github+json" repos/$owner/$repo/actions/secrets 2>$null
          if ($LASTEXITCODE -ne 0 -or -not $respJson) {
            Write-Error "Failed to fetch repository secrets via GitHub API"
            exit 1
          }
          
          $resp = $respJson | ConvertFrom-Json
          $names = @()
          if ($resp -and $resp.secrets) { $names = $resp.secrets | ForEach-Object { $_.name } }

          function Check-Secret([string]$name) {
            if ($names -contains $name) {
              Write-Host "  âœ… $name present" -ForegroundColor Green
              return $true
            } else {
              Write-Host "  âŒ $name missing" -ForegroundColor Red
              return $false
            }
          }

          $requiredSecrets = @("AZUREAPPSERVICE_CLIENTID", "AZUREAPPSERVICE_TENANTID", "AZUREAPPSERVICE_SUBSCRIPTIONID")
          $allPresent = $true
          foreach ($secretName in $requiredSecrets) {
            if (-not (Check-Secret -name $secretName)) {
              $allPresent = $false
            }
          }

          # Add to job summary
          "### ðŸ”‘ Repository Secrets" >> $env:GITHUB_STEP_SUMMARY
          if ($names.Count -gt 0) {
            foreach ($n in $names | Sort-Object) { "- $n" >> $env:GITHUB_STEP_SUMMARY }
          } else {
            "- (no secrets found)" >> $env:GITHUB_STEP_SUMMARY
          }
          "" >> $env:GITHUB_STEP_SUMMARY

          if (-not $allPresent) {
            Write-Error "One or more required repository secrets are missing. See logs above and summary for details."
            exit 1
          } else {
            Write-Host "âœ… All required repository secrets verified." -ForegroundColor Green
          }

          Write-Host "UTC End: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "---- END REPOSITORY SECRET VERIFICATION ----" -ForegroundColor Cyan

      - name: Verify Environment Secrets
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_APP_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          Write-Host "---- BEGIN ENVIRONMENT SECRET VERIFICATION ----" -ForegroundColor Cyan
          Write-Host "UTC Start: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          
          # Determine authentication method
          $token = $null
          if ($env:GH_APP_TOKEN) {
            $token = $env:GH_APP_TOKEN
            Write-Host "Using GitHub App token for verification" -ForegroundColor Green
          } elseif ($env:GH_PAT) {
            $token = $env:GH_PAT
            Write-Host "Using PAT for verification" -ForegroundColor Yellow
          }
          
          # Check if authentication is available
          if (-not $token) {
            Write-Host "âš ï¸  No authentication configured - skipping environment secret verification" -ForegroundColor Yellow
            Write-Host "    Environment secrets can only be verified with GitHub App or PAT" -ForegroundColor Yellow
            Write-Host "---- END ENVIRONMENT SECRET VERIFICATION ----" -ForegroundColor Cyan
            exit 0
          }
          
          # Set GH_TOKEN for gh CLI commands
          $env:GH_TOKEN = $token
          
          $selectedEnv = "${{ inputs.environment }}"
          $environments = @()
          if ($selectedEnv -eq "all") {
            $environments = @("dev", "staging", "prod")
          } else {
            $environments = @($selectedEnv)
          }
          
          Write-Host "ðŸ”Ž Verifying environment secrets for: $($environments -join ', ')..." -ForegroundColor Cyan
          
          $ownerRepo = "${{ github.repository }}"
          $owner, $repo = $ownerRepo -split '/', 2
          
          $allVerified = $true
          
          foreach ($env_name in $environments) {
            Write-Host "`n  Environment: $env_name" -ForegroundColor Yellow
            
            try {
              $respJson = gh api -H "Accept: application/vnd.github+json" repos/$owner/$repo/environments/$env_name/secrets 2>$null
              
              if ($LASTEXITCODE -ne 0 -or -not $respJson) {
                Write-Host "    âš ï¸  Could not fetch environment secrets (environment may not exist yet)" -ForegroundColor Yellow
                continue
              }
              
              $resp = $respJson | ConvertFrom-Json
              $names = @()
              if ($resp -and $resp.secrets) { 
                $names = $resp.secrets | ForEach-Object { $_.name } 
              }
              
              $requiredSecrets = @("AZUREAPPSERVICE_CLIENTID", "AZUREAPPSERVICE_TENANTID", "AZUREAPPSERVICE_SUBSCRIPTIONID")
              
              foreach ($secretName in $requiredSecrets) {
                if ($names -contains $secretName) {
                  Write-Host "    âœ… $secretName present" -ForegroundColor Green
                } else {
                  Write-Host "    âŒ $secretName missing" -ForegroundColor Red
                  $allVerified = $false
                }
              }
              
              # Add to job summary
              "### ðŸ”‘ Environment Secrets ($env_name)" >> $env:GITHUB_STEP_SUMMARY
              if ($names.Count -gt 0) {
                foreach ($n in $names | Sort-Object) { "- $n" >> $env:GITHUB_STEP_SUMMARY }
              } else {
                "- (no secrets found)" >> $env:GITHUB_STEP_SUMMARY
              }
              "" >> $env:GITHUB_STEP_SUMMARY
              
            } catch {
              Write-Host "    âš ï¸  Error verifying environment secrets: $($_.Exception.Message)" -ForegroundColor Yellow
            }
          }
          
          if ($allVerified) {
            Write-Host "`nâœ… All environment secrets verified successfully!" -ForegroundColor Green
          } else {
            Write-Host "`nâš ï¸  Some environment secrets may be missing - check logs above" -ForegroundColor Yellow
          }
          
          Write-Host "UTC End: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
          Write-Host "---- END ENVIRONMENT SECRET VERIFICATION ----" -ForegroundColor Cyan

  bootstrap-dev:
    name: Bootstrap Dev Environment
    if: inputs.bootstrapInfra && (inputs.environment == 'dev' || inputs.environment == 'all')
    needs: [setup-oidc, configure-secrets]
    runs-on: windows-latest
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate Azure Credentials
        run: |
          if (-not "$env:CLIENT_ID" -or -not "$env:TENANT_ID" -or -not "$env:SUBSCRIPTION_ID") {
            Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      - name: Bootstrap Dev Infrastructure
        run: |
          Write-Host "ðŸš€ Bootstrapping Dev Environment..." -ForegroundColor Cyan
          Write-Host "" -ForegroundColor Gray
          Write-Host "ðŸ“‹ Configuration:" -ForegroundColor Yellow
          Write-Host "  Branch: dev" -ForegroundColor Gray
          Write-Host "  Environment: dev" -ForegroundColor Gray
          Write-Host "  Parameter File: infra/parameters/dev.json" -ForegroundColor Gray
          Write-Host "  Resource Group: rg-orderprocessing-dev" -ForegroundColor Gray
          Write-Host "  OIDC Subject: repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/dev" -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray
          
          ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment dev
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-dev
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  bootstrap-staging:
    name: Bootstrap Staging Environment
    if: inputs.bootstrapInfra && (inputs.environment == 'staging' || inputs.environment == 'all')
    needs: [setup-oidc, configure-secrets]
    runs-on: windows-latest
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate Azure Credentials
        run: |
          if (-not "$env:CLIENT_ID" -or -not "$env:TENANT_ID" -or -not "$env:SUBSCRIPTION_ID") {
            Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      - name: Bootstrap Staging Infrastructure
        run: |
          Write-Host "ðŸš€ Bootstrapping Staging Environment..." -ForegroundColor Cyan
          Write-Host "" -ForegroundColor Gray
          Write-Host "ðŸ“‹ Configuration:" -ForegroundColor Yellow
          Write-Host "  Branch: staging" -ForegroundColor Gray
          Write-Host "  Environment: staging" -ForegroundColor Gray
          Write-Host "  Parameter File: infra/parameters/staging.json" -ForegroundColor Gray
          Write-Host "  Resource Group: rg-orderprocessing-staging" -ForegroundColor Gray
          Write-Host "  OIDC Subject: repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/staging" -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray
          
          ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment staging
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-staging
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  bootstrap-prod:
    name: Bootstrap Production Environment
    if: inputs.bootstrapInfra && (inputs.environment == 'prod' || inputs.environment == 'all')
    needs: [setup-oidc, configure-secrets]
    runs-on: windows-latest
    environment: prod
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate Azure Credentials
        run: |
          if (-not "$env:CLIENT_ID" -or -not "$env:TENANT_ID" -or -not "$env:SUBSCRIPTION_ID") {
            Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      - name: Bootstrap Prod Infrastructure
        run: |
          Write-Host "ðŸš€ Bootstrapping Prod Environment..." -ForegroundColor Cyan
          Write-Host "" -ForegroundColor Gray
          Write-Host "ðŸ“‹ Configuration:" -ForegroundColor Yellow
          Write-Host "  Branch: main" -ForegroundColor Gray
          Write-Host "  Environment: prod" -ForegroundColor Gray
          Write-Host "  Parameter File: infra/parameters/prod.json" -ForegroundColor Gray
          Write-Host "  Resource Group: rg-orderprocessing-prod" -ForegroundColor Gray
          Write-Host "  OIDC Subject: repo:pavanthakur/XYDataLabs.OrderProcessingSystem:ref:refs/heads/main" -ForegroundColor Gray
          Write-Host "" -ForegroundColor Gray
          
          ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment prod
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-prod
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  enable-validation:
    name: Enable Pre-Deployment Validation
    if: inputs.enableValidation && inputs.bootstrapInfra
    needs: [bootstrap-dev, bootstrap-staging, bootstrap-prod]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Enable Validation in Workflow
        run: |
          Write-Host "ðŸ”§ Enabling pre-deployment validation..." -ForegroundColor Cyan
          
          $workflowPath = ".github/workflows/infra-deploy.yml"
          $content = Get-Content $workflowPath -Raw
          
          # Re-enable pre-validate job
          $content = $content -replace 'if: false  # TODO: Enable after bootstrap - requires Azure OIDC setup', 'if: (github.event_name == ''push'') || (github.event_name == ''workflow_dispatch'' && !inputs.dryRun)'
          
          # Re-enable job dependency
          $content = $content -replace '# needs: pre-validate  # TODO: Uncomment after bootstrap', 'needs: pre-validate'
          
          Set-Content $workflowPath -Value $content -NoNewline
          
          Write-Host "âœ… Validation enabled" -ForegroundColor Green
      
      - name: Commit Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/infra-deploy.yml
          git diff --staged --quiet || git commit -m "chore(ci): enable pre-deployment validation after bootstrap"
          git push
      
      - name: Create Completion Summary
        run: |
          "## âœ… Azure Bootstrap Complete!" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸŽ‰ What's Ready" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… Azure OIDC configured" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… GitHub secrets configured" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… Infrastructure bootstrapped (${{ inputs.environment }})" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… Pre-deployment validation enabled" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸš€ Next Steps" >> $env:GITHUB_STEP_SUMMARY
          "1. Push code changes to trigger deployment workflow" >> $env:GITHUB_STEP_SUMMARY
          "2. Monitor deployments at: [Actions](https://github.com/pavanthakur/XYDataLabs.OrderProcessingSystem/actions)" >> $env:GITHUB_STEP_SUMMARY
          "3. View resources in [Azure Portal](https://portal.azure.com)" >> $env:GITHUB_STEP_SUMMARY

  summary:
    name: Bootstrap Summary
    if: always() && github.event_name == 'workflow_dispatch'
    needs: [setup-oidc, configure-secrets, bootstrap-dev, bootstrap-staging, bootstrap-prod, enable-validation]
    runs-on: windows-latest
    steps:
      - name: Generate Summary
        run: |
          "## ðŸ“Š Bootstrap Workflow Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          
          $setupOidc = "${{ needs.setup-oidc.result }}"
          $configSecrets = "${{ needs.configure-secrets.result }}"
          $bootstrapDev = "${{ needs.bootstrap-dev.result }}"
          $bootstrapStaging = "${{ needs.bootstrap-staging.result }}"
          $bootstrapProd = "${{ needs.bootstrap-prod.result }}"
          $enableVal = "${{ needs.enable-validation.result }}"
          
          "| Step | Status |" >> $env:GITHUB_STEP_SUMMARY
          "|------|--------|" >> $env:GITHUB_STEP_SUMMARY
          
          if ($setupOidc -ne "") {
            $icon = if ($setupOidc -eq "success") { "âœ…" } else { "âŒ" }
            "| Setup OIDC | $icon $setupOidc |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($configSecrets -ne "") {
            $icon = if ($configSecrets -eq "success") { "âœ…" } else { "âŒ" }
            "| Configure Secrets | $icon $configSecrets |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($bootstrapDev -ne "") {
            $icon = if ($bootstrapDev -eq "success") { "âœ…" } elseif ($bootstrapDev -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Dev | $icon $bootstrapDev |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($bootstrapStaging -ne "") {
            $icon = if ($bootstrapStaging -eq "success") { "âœ…" } elseif ($bootstrapStaging -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Staging | $icon $bootstrapStaging |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($bootstrapProd -ne "") {
            $icon = if ($bootstrapProd -eq "success") { "âœ…" } elseif ($bootstrapProd -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Prod | $icon $bootstrapProd |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($enableVal -ne "") {
            $icon = if ($enableVal -eq "success") { "âœ…" } elseif ($enableVal -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Enable Validation | $icon $enableVal |" >> $env:GITHUB_STEP_SUMMARY
          }
