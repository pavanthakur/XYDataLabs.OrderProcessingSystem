name: Azure Bootstrap Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to bootstrap'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
          - all
      setupOidc:
        description: 'Setup OIDC (first-time only)'
        required: true
        type: boolean
        default: false
      configureSecrets:
        description: 'Configure GitHub secrets (requires GitHub token)'
        required: true
        type: boolean
        default: false
      bootstrapInfra:
        description: 'Bootstrap infrastructure (App Services, etc.)'
        required: true
        type: boolean
        default: true
      enableValidation:
        description: 'Enable pre-deployment validation after bootstrap'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  setup-oidc:
    name: Setup Azure OIDC
    if: inputs.setupOidc
    runs-on: windows-latest
    outputs:
      clientId: ${{ steps.oidc.outputs.clientId }}
      tenantId: ${{ steps.oidc.outputs.tenantId }}
      subscriptionId: ${{ steps.oidc.outputs.subscriptionId }}
      appObjectId: ${{ steps.oidc.outputs.appObjectId }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login (Device Code)
        timeout-minutes: 3
        run: |
          Write-Host "ðŸ” Azure Login Required" -ForegroundColor Cyan
          Write-Host "This is a one-time setup. Please authenticate when prompted." -ForegroundColor Yellow
          Write-Host "â±ï¸  Timeout: 3 minutes" -ForegroundColor Yellow
          az login --use-device-code
      
      - name: Setup OIDC App Registration
        id: oidc
        run: |
          Write-Host "ðŸš€ Setting up GitHub Actions OIDC..." -ForegroundColor Cyan
          
          # Run setup script
          ./Resources/Azure-Deployment/setup-github-oidc.ps1 `
            -Branches "dev,staging,main" `
            -Environments "dev,staging,prod" `
            -GitHubOwner "pavanthakur" `
            -Repository "XYDataLabs.OrderProcessingSystem"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "OIDC setup failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          # Extract credentials from Azure
          $sub = az account show | ConvertFrom-Json
          if (-not $sub) {
            Write-Error "Failed to get Azure subscription"
            exit 1
          }
          
          $app = az ad app list --display-name "GitHub-Actions-OIDC" | ConvertFrom-Json
          if (-not $app -or $app.Count -eq 0) {
            Write-Error "Failed to create or find OIDC app"
            exit 1
          }
          
          $clientId = $app[0].appId
          $appObjectId = $app[0].id
          $tenantId = $sub.tenantId
          $subscriptionId = $sub.id
          
          # Output for next jobs
          "clientId=$clientId" >> $env:GITHUB_OUTPUT
          "tenantId=$tenantId" >> $env:GITHUB_OUTPUT
          "subscriptionId=$subscriptionId" >> $env:GITHUB_OUTPUT
          "appObjectId=$appObjectId" >> $env:GITHUB_OUTPUT
          
          Write-Host "âœ… OIDC Setup Complete" -ForegroundColor Green
          Write-Host "   Client ID: $clientId" -ForegroundColor Gray
          Write-Host "   Tenant ID: $tenantId" -ForegroundColor Gray
          Write-Host "   App Object ID: $appObjectId" -ForegroundColor Gray
      
      - name: Verify Federated Credentials
        run: |
          Write-Host "ðŸ” Verifying federated credentials..." -ForegroundColor Cyan
          $appObjectId = "${{ steps.oidc.outputs.appObjectId }}"
          $creds = az ad app federated-credential list --id $appObjectId | ConvertFrom-Json
          
          Write-Host "`nCreated federated credentials:" -ForegroundColor Green
          foreach ($cred in $creds) {
            Write-Host "  - Name: $($cred.name)" -ForegroundColor White
            Write-Host "    Subject: $($cred.subject)" -ForegroundColor Gray
          }
          
          if ($creds.Count -lt 6) {
            Write-Warning "Expected 6 federated credentials, found $($creds.Count). OIDC setup may be incomplete."
          }
      
      - name: Create Setup Summary
        run: |
          "## ðŸ” Azure OIDC Setup Complete" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸ“‹ Next Steps" >> $env:GITHUB_STEP_SUMMARY
          "1. Add these secrets to GitHub (if not using automated secret configuration):" >> $env:GITHUB_STEP_SUMMARY
          "   - AZUREAPPSERVICE_CLIENTID: ``${{ steps.oidc.outputs.clientId }}``" >> $env:GITHUB_STEP_SUMMARY
          "   - AZUREAPPSERVICE_TENANTID: ``${{ steps.oidc.outputs.tenantId }}``" >> $env:GITHUB_STEP_SUMMARY
          "   - AZUREAPPSERVICE_SUBSCRIPTIONID: ``${{ steps.oidc.outputs.subscriptionId }}``" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "2. Re-run this workflow with ``Configure GitHub secrets`` enabled" >> $env:GITHUB_STEP_SUMMARY
          "3. Then run with ``Bootstrap infrastructure`` enabled" >> $env:GITHUB_STEP_SUMMARY

  configure-secrets:
    name: Configure GitHub Secrets
    if: inputs.configureSecrets && !cancelled()
    needs: [setup-oidc]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Required Secrets
        id: check
        run: |
          $hasClientId = "${{ secrets.AZUREAPPSERVICE_CLIENTID }}" -ne ""
          $hasTenantId = "${{ secrets.AZUREAPPSERVICE_TENANTID }}" -ne ""
          $hasSubscriptionId = "${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}" -ne ""
          
          if ($hasClientId -and $hasTenantId -and $hasSubscriptionId) {
            Write-Host "âœ… All secrets already configured" -ForegroundColor Green
            "secretsExist=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âš ï¸ Secrets missing, will attempt configuration" -ForegroundColor Yellow
            "secretsExist=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Set Dev Environment Secrets
        if: steps.check.outputs.secretsExist == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId }}
          TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId }}
          SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId }}
        run: |
          Write-Host "ðŸ”‘ Setting GitHub environment secrets for 'dev'..." -ForegroundColor Cyan
          gh secret set AZUREAPPSERVICE_CLIENTID --env dev --repo ${{ github.repository }} --body "$env:CLIENT_ID"
          gh secret set AZUREAPPSERVICE_TENANTID --env dev --repo ${{ github.repository }} --body "$env:TENANT_ID"
          gh secret set AZUREAPPSERVICE_SUBSCRIPTIONID --env dev --repo ${{ github.repository }} --body "$env:SUBSCRIPTION_ID"
          Write-Host "âœ… Environment secrets set for 'dev'!" -ForegroundColor Green

  bootstrap-dev:
    name: Bootstrap Dev Environment
    if: inputs.bootstrapInfra && (inputs.environment == 'dev' || inputs.environment == 'all') && !cancelled()
    needs: [setup-oidc, configure-secrets]
    runs-on: windows-latest
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate Azure Credentials
        run: |
          if (-not "$env:CLIENT_ID" -or -not "$env:TENANT_ID" -or -not "$env:SUBSCRIPTION_ID") {
            Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      - name: Bootstrap Dev Infrastructure
        run: |
          Write-Host "ðŸš€ Bootstrapping Dev Environment..." -ForegroundColor Cyan
          ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment dev
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-dev
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  bootstrap-staging:
    name: Bootstrap Staging Environment
    if: inputs.bootstrapInfra && (inputs.environment == 'staging' || inputs.environment == 'all') && !cancelled()
    needs: [setup-oidc, configure-secrets]
    runs-on: windows-latest
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate Azure Credentials
        run: |
          if (-not "$env:CLIENT_ID" -or -not "$env:TENANT_ID" -or -not "$env:SUBSCRIPTION_ID") {
            Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      - name: Bootstrap Staging Infrastructure
        run: |
          Write-Host "ðŸš€ Bootstrapping Staging Environment..." -ForegroundColor Cyan
          ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment stg
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-staging
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  bootstrap-prod:
    name: Bootstrap Production Environment
    if: inputs.bootstrapInfra && (inputs.environment == 'prod' || inputs.environment == 'all') && !cancelled()
    needs: [setup-oidc, configure-secrets]
    runs-on: windows-latest
    environment: prod
    env:
      CLIENT_ID: ${{ needs.setup-oidc.outputs.clientId || secrets.AZUREAPPSERVICE_CLIENTID }}
      TENANT_ID: ${{ needs.setup-oidc.outputs.tenantId || secrets.AZUREAPPSERVICE_TENANTID }}
      SUBSCRIPTION_ID: ${{ needs.setup-oidc.outputs.subscriptionId || secrets.AZUREAPPSERVICE_SUBSCRIPTIONID }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate Azure Credentials
        run: |
          if (-not "$env:CLIENT_ID" -or -not "$env:TENANT_ID" -or -not "$env:SUBSCRIPTION_ID") {
            Write-Error "Azure credentials not found. Ensure OIDC setup is run or secrets are configured."
            exit 1
          }
      - name: Azure Login (OIDC or Secrets)
        timeout-minutes: 3
        uses: azure/login@v2
        with:
          client-id: ${{ env.CLIENT_ID }}
          tenant-id: ${{ env.TENANT_ID }}
          subscription-id: ${{ env.SUBSCRIPTION_ID }}
      - name: Bootstrap Production Infrastructure
        run: |
          Write-Host "ðŸš€ Bootstrapping Production Environment..." -ForegroundColor Cyan
          ./Resources/Azure-Deployment/bootstrap-enterprise-infra.ps1 -Environment prod
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Bootstrap failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
      - name: Upload Bootstrap Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-log-prod
          path: Resources/Azure-Deployment/logs/bootstrap-*.log
          retention-days: 30

  enable-validation:
    name: Enable Pre-Deployment Validation
    if: inputs.enableValidation && inputs.bootstrapInfra && !cancelled()
    needs: [bootstrap-dev, bootstrap-staging, bootstrap-prod]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Enable Validation in Workflow
        run: |
          Write-Host "ðŸ”§ Enabling pre-deployment validation..." -ForegroundColor Cyan
          
          $workflowPath = ".github/workflows/infra-deploy.yml"
          $content = Get-Content $workflowPath -Raw
          
          # Re-enable pre-validate job
          $content = $content -replace 'if: false  # TODO: Enable after bootstrap - requires Azure OIDC setup', 'if: (github.event_name == ''push'') || (github.event_name == ''workflow_dispatch'' && !inputs.dryRun)'
          
          # Re-enable job dependency
          $content = $content -replace '# needs: pre-validate  # TODO: Uncomment after bootstrap', 'needs: pre-validate'
          
          Set-Content $workflowPath -Value $content -NoNewline
          
          Write-Host "âœ… Validation enabled" -ForegroundColor Green
      
      - name: Commit Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/infra-deploy.yml
          git diff --staged --quiet || git commit -m "chore(ci): enable pre-deployment validation after bootstrap"
          git push
      
      - name: Create Completion Summary
        run: |
          "## âœ… Azure Bootstrap Complete!" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸŽ‰ What's Ready" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… Azure OIDC configured" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… GitHub secrets configured" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… Infrastructure bootstrapped (${{ inputs.environment }})" >> $env:GITHUB_STEP_SUMMARY
          "- âœ… Pre-deployment validation enabled" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸš€ Next Steps" >> $env:GITHUB_STEP_SUMMARY
          "1. Push code changes to trigger deployment workflow" >> $env:GITHUB_STEP_SUMMARY
          "2. Monitor deployments at: [Actions](https://github.com/pavanthakur/XYDataLabs.OrderProcessingSystem/actions)" >> $env:GITHUB_STEP_SUMMARY
          "3. View resources in [Azure Portal](https://portal.azure.com)" >> $env:GITHUB_STEP_SUMMARY

  summary:
    name: Bootstrap Summary
    if: always()
    needs: [setup-oidc, configure-secrets, bootstrap-dev, bootstrap-staging, bootstrap-prod, enable-validation]
    runs-on: windows-latest
    steps:
      - name: Generate Summary
        run: |
          "## ðŸ“Š Bootstrap Workflow Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          
          $setupOidc = "${{ needs.setup-oidc.result }}"
          $configSecrets = "${{ needs.configure-secrets.result }}"
          $bootstrapDev = "${{ needs.bootstrap-dev.result }}"
          $bootstrapStaging = "${{ needs.bootstrap-staging.result }}"
          $bootstrapProd = "${{ needs.bootstrap-prod.result }}"
          $enableVal = "${{ needs.enable-validation.result }}"
          
          "| Step | Status |" >> $env:GITHUB_STEP_SUMMARY
          "|------|--------|" >> $env:GITHUB_STEP_SUMMARY
          
          if ($setupOidc -ne "") {
            $icon = if ($setupOidc -eq "success") { "âœ…" } else { "âŒ" }
            "| Setup OIDC | $icon $setupOidc |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($configSecrets -ne "") {
            $icon = if ($configSecrets -eq "success") { "âœ…" } else { "âŒ" }
            "| Configure Secrets | $icon $configSecrets |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($bootstrapDev -ne "") {
            $icon = if ($bootstrapDev -eq "success") { "âœ…" } elseif ($bootstrapDev -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Dev | $icon $bootstrapDev |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($bootstrapStaging -ne "") {
            $icon = if ($bootstrapStaging -eq "success") { "âœ…" } elseif ($bootstrapStaging -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Staging | $icon $bootstrapStaging |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($bootstrapProd -ne "") {
            $icon = if ($bootstrapProd -eq "success") { "âœ…" } elseif ($bootstrapProd -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Bootstrap Prod | $icon $bootstrapProd |" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ($enableVal -ne "") {
            $icon = if ($enableVal -eq "success") { "âœ…" } elseif ($enableVal -eq "skipped") { "â­ï¸" } else { "âŒ" }
            "| Enable Validation | $icon $enableVal |" >> $env:GITHUB_STEP_SUMMARY
          }
